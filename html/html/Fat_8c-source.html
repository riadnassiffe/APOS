<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>APOS: Código-Fonte de src/kernel/Fat.c</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Gerado por Doxygen 1.5.5 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Página&nbsp;Principal</span></a></li>
      <li><a href="annotated.html"><span>Estruturas&nbsp;de&nbsp;Dados</span></a></li>
      <li class="current"><a href="files.html"><span>Arquivos</span></a></li>
    </ul>
  </div>
<h1>src/kernel/Fat.c</h1><a href="Fat_8c.html">Vá para a documentação deste arquivo.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Implementação baseada na versão anterior do APOS.</span>
<a name="l00003"></a>00003 <span class="comment"> * Orientador: Edeyson Andrade Gomes   edeyson\gmail.com</span>
<a name="l00004"></a>00004 <span class="comment"> * Aluno: Ríad Mattos Nassiffe            riad.nassiffe\gmail.com</span>
<a name="l00005"></a>00005 <span class="comment"> */</span>
<a name="l00012"></a>00012 <span class="preprocessor">#include "<a class="code" href="Fat_8h.html">include/Fat.h</a>"</span>
<a name="l00013"></a>00013 
<a name="l00017"></a><a class="code" href="Fat_8c.html#94c34059cc559423cf5a00bcc19217e0">00017</a> <span class="keyword">struct </span><a class="code" href="structFatInstance.html" title="Guardar todas informações sobre o sistema de arquivo de um dispositivo.">FatInstance</a> *<a class="code" href="Fat_8c.html#94c34059cc559423cf5a00bcc19217e0" title="Estrutura que guarda informações sobre a formatação das partições encontradas...">VolumesListed</a>;
<a name="l00021"></a><a class="code" href="Fat_8c.html#fb6a77f8fd1dc0be5fb353a7c656387f">00021</a> <span class="keywordtype">int</span> <a class="code" href="Fat_8c.html#fb6a77f8fd1dc0be5fb353a7c656387f" title="Variavel que ativa o modo debug, se seu valor for TRUE(1) e desativa se for FALSE(0)...">debugVariable</a> = <a class="code" href="Defs_8h.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00022"></a>00022 
<a name="l00027"></a><a class="code" href="KFat_8h.html#8ade7c95fb9669c2a42b8950474b84af">00027</a> <span class="keywordtype">int</span> <a class="code" href="Fat_8c.html#8ade7c95fb9669c2a42b8950474b84af" title="Esta função deve carrega todos os volumes detectados, e listados pelo drive IDE...">loadFatIDEDrivers</a>() {
<a name="l00028"></a>00028         <span class="keywordtype">int</span> status;
<a name="l00029"></a>00029         <span class="keywordtype">int</span> count;
<a name="l00030"></a>00030         <span class="keywordtype">int</span> ide = 0;
<a name="l00031"></a>00031         <span class="keyword">struct </span><a class="code" href="structFatInstance.html" title="Guardar todas informações sobre o sistema de arquivo de um dispositivo.">FatInstance</a> *list;
<a name="l00032"></a>00032         
<a name="l00033"></a>00033         <span class="comment">//pegar a quantidade de volumes encontrados.</span>
<a name="l00034"></a>00034         ide = <a class="code" href="Ide_8c.html#289154455e46f469d1835f652a7a58af" title="Essa função verifica a quantidade de HDs detectados.">getDisks</a>();
<a name="l00035"></a>00035         <a class="code" href="Scrn_8h.html#273a809d3de4626e50ad4ecd05c44754" title="Responsável por imprimir mensagens de debug na tela.">APOSDEBUG</a>(<a class="code" href="Fat_8c.html#fb6a77f8fd1dc0be5fb353a7c656387f" title="Variavel que ativa o modo debug, se seu valor for TRUE(1) e desativa se for FALSE(0)...">debugVariable</a>, <span class="stringliteral">"ide = : "</span>);
<a name="l00036"></a>00036         <a class="code" href="Scrn_8h.html#3b47c20d8bb9e5c9d3cd0137c247ed81" title="Imprime na tela um inteiro.">printfInt</a>(ide);
<a name="l00037"></a>00037         <a class="code" href="Scrn_8h.html#273a809d3de4626e50ad4ecd05c44754" title="Responsável por imprimir mensagens de debug na tela.">APOSDEBUG</a>(<a class="code" href="Fat_8c.html#fb6a77f8fd1dc0be5fb353a7c656387f" title="Variavel que ativa o modo debug, se seu valor for TRUE(1) e desativa se for FALSE(0)...">debugVariable</a>, <span class="stringliteral">"hd..... \n"</span>);
<a name="l00038"></a>00038 
<a name="l00039"></a>00039         <span class="comment">/*</span>
<a name="l00040"></a>00040 <span class="comment">         * Cria uma lista, com entrada para cada dispositivo encontrado. A lista</span>
<a name="l00041"></a>00041 <span class="comment">         * é criada de acordo com o número de dispositivos encontrados.Se for encontrado um,</span>
<a name="l00042"></a>00042 <span class="comment">         * cria-se uma lista com apenas uma entrada, caso contrario cria-se uma lista com duas </span>
<a name="l00043"></a>00043 <span class="comment">         * entradas</span>
<a name="l00044"></a>00044 <span class="comment">         */</span>
<a name="l00045"></a>00045         <span class="keywordflow">if</span> (ide == 1) {
<a name="l00046"></a>00046                 <a class="code" href="Scrn_8h.html#273a809d3de4626e50ad4ecd05c44754" title="Responsável por imprimir mensagens de debug na tela.">APOSDEBUG</a>(<a class="code" href="Fat_8c.html#fb6a77f8fd1dc0be5fb353a7c656387f" title="Variavel que ativa o modo debug, se seu valor for TRUE(1) e desativa se for FALSE(0)...">debugVariable</a>, <span class="stringliteral">"inicializando com apenas 1 hd"</span>);
<a name="l00047"></a>00047                 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structFatInstance.html" title="Guardar todas informações sobre o sistema de arquivo de um dispositivo.">FatInstance</a> instance;
<a name="l00048"></a>00048                 list = &amp;instance;
<a name="l00049"></a>00049                 <span class="comment">//Passa o endereço do da lista de drives ide para IDEdriverList.</span>
<a name="l00050"></a>00050                 VolumesListed = list;
<a name="l00051"></a>00051                 <a class="code" href="Scrn_8h.html#273a809d3de4626e50ad4ecd05c44754" title="Responsável por imprimir mensagens de debug na tela.">APOSDEBUG</a>(<a class="code" href="Fat_8c.html#fb6a77f8fd1dc0be5fb353a7c656387f" title="Variavel que ativa o modo debug, se seu valor for TRUE(1) e desativa se for FALSE(0)...">debugVariable</a>, <span class="stringliteral">" \n inicializado com apenas 1 hd"</span>);
<a name="l00052"></a>00052         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ide == 2) {
<a name="l00053"></a>00053                 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structFatInstance.html" title="Guardar todas informações sobre o sistema de arquivo de um dispositivo.">FatInstance</a> instance[2];
<a name="l00054"></a>00054                 list = &amp;instance[0];
<a name="l00055"></a>00055                 <span class="comment">//Passa o endereço do da lista de drives ide para IDEdriverList.</span>
<a name="l00056"></a>00056                 VolumesListed = list;
<a name="l00057"></a>00057         } <span class="keywordflow">else</span> {
<a name="l00058"></a>00058                 <a class="code" href="Scrn_8h.html#273a809d3de4626e50ad4ecd05c44754" title="Responsável por imprimir mensagens de debug na tela.">APOSDEBUG</a>(<a class="code" href="Fat_8c.html#fb6a77f8fd1dc0be5fb353a7c656387f" title="Variavel que ativa o modo debug, se seu valor for TRUE(1) e desativa se for FALSE(0)...">debugVariable</a>,
<a name="l00059"></a>00059                                 <span class="stringliteral">"nenhum dispositivo de armazenamento foi encontrado..... \n"</span>);
<a name="l00060"></a>00060         }
<a name="l00061"></a>00061         <span class="comment">/*</span>
<a name="l00062"></a>00062 <span class="comment">         *Para cada dispositivo encontrado ele verifica se eles já foram formatados,</span>
<a name="l00063"></a>00063 <span class="comment">         *caso não tenham sido, ele formata.</span>
<a name="l00064"></a>00064 <span class="comment">         */</span>
<a name="l00065"></a>00065         <span class="keywordflow">for</span> (count = 0; count &lt; ide; count++) {
<a name="l00066"></a>00066                 <a class="code" href="Scrn_8h.html#273a809d3de4626e50ad4ecd05c44754" title="Responsável por imprimir mensagens de debug na tela.">APOSDEBUG</a>(<a class="code" href="Fat_8c.html#fb6a77f8fd1dc0be5fb353a7c656387f" title="Variavel que ativa o modo debug, se seu valor for TRUE(1) e desativa se for FALSE(0)...">debugVariable</a>, <span class="stringliteral">" \n executando loadList..."</span>);
<a name="l00067"></a>00067                 <span class="comment">/*</span>
<a name="l00068"></a>00068 <span class="comment">                 * A função abaixo tenta caregar as informações do HD.</span>
<a name="l00069"></a>00069 <span class="comment">                 */</span>
<a name="l00070"></a>00070                 status = <a class="code" href="Fat_8c.html#ab5b856bdea33a3bcd6b92b3741190d4" title="Tenta carregar na LBA 0 do dispositivo o BS, do sistema de partição, se não conseguir...">loadFatList</a>(count);
<a name="l00071"></a>00071                 <a class="code" href="Scrn_8h.html#273a809d3de4626e50ad4ecd05c44754" title="Responsável por imprimir mensagens de debug na tela.">APOSDEBUG</a>(<a class="code" href="Fat_8c.html#fb6a77f8fd1dc0be5fb353a7c656387f" title="Variavel que ativa o modo debug, se seu valor for TRUE(1) e desativa se for FALSE(0)...">debugVariable</a>, <span class="stringliteral">" voltando para loadFatIDEDrivers...\n"</span>);
<a name="l00072"></a>00072                 <span class="comment">/*caso o loadFatlist retoner sucesso ele mostra a mensagem de sistema de </span>
<a name="l00073"></a>00073 <span class="comment">                 * arquivo compativel encontrado, caso contrario formata a partição.</span>
<a name="l00074"></a>00074 <span class="comment">                 */</span>
<a name="l00075"></a>00075                 <span class="keywordflow">if</span> (status == 0) {
<a name="l00076"></a>00076                         <a class="code" href="Scrn_8h.html#273a809d3de4626e50ad4ecd05c44754" title="Responsável por imprimir mensagens de debug na tela.">APOSDEBUG</a>(<a class="code" href="Fat_8c.html#fb6a77f8fd1dc0be5fb353a7c656387f" title="Variavel que ativa o modo debug, se seu valor for TRUE(1) e desativa se for FALSE(0)...">debugVariable</a>,
<a name="l00077"></a>00077                                         <span class="stringliteral">"Dispositivo com sistema e arquivos compativel encontrado....\n"</span>);
<a name="l00078"></a>00078                 } <span class="keywordflow">else</span> {
<a name="l00079"></a>00079                         <a class="code" href="Scrn_8h.html#273a809d3de4626e50ad4ecd05c44754" title="Responsável por imprimir mensagens de debug na tela.">APOSDEBUG</a>(<a class="code" href="Fat_8c.html#fb6a77f8fd1dc0be5fb353a7c656387f" title="Variavel que ativa o modo debug, se seu valor for TRUE(1) e desativa se for FALSE(0)...">debugVariable</a>,
<a name="l00080"></a>00080                                         <span class="stringliteral">"Dispositivo com sistema e arquivos incompativel encontrado....\n"</span>);
<a name="l00081"></a>00081                         <a class="code" href="Scrn_8h.html#273a809d3de4626e50ad4ecd05c44754" title="Responsável por imprimir mensagens de debug na tela.">APOSDEBUG</a>(<a class="code" href="Fat_8c.html#fb6a77f8fd1dc0be5fb353a7c656387f" title="Variavel que ativa o modo debug, se seu valor for TRUE(1) e desativa se for FALSE(0)...">debugVariable</a>, <span class="stringliteral">"Sistema dispositivo sendo formatado \n"</span>);
<a name="l00082"></a>00082                         status = <a class="code" href="Fat_8c.html#9588e166a75e2559d64aa27132b5e28f" title="Fomata o disco, no sistema de partição AFS2.0, criando uma bs e um Fat para ele...">formatDisk</a>(count);
<a name="l00083"></a>00083                         <span class="keywordflow">if</span> (status == 0) {
<a name="l00084"></a>00084                                 <a class="code" href="Scrn_8h.html#273a809d3de4626e50ad4ecd05c44754" title="Responsável por imprimir mensagens de debug na tela.">APOSDEBUG</a>(<a class="code" href="Fat_8c.html#fb6a77f8fd1dc0be5fb353a7c656387f" title="Variavel que ativa o modo debug, se seu valor for TRUE(1) e desativa se for FALSE(0)...">debugVariable</a>, <span class="stringliteral">"Disco formatado com sucesso .... \n"</span>);
<a name="l00085"></a>00085                         } <span class="keywordflow">else</span> {
<a name="l00086"></a>00086                                 <a class="code" href="Scrn_8h.html#273a809d3de4626e50ad4ecd05c44754" title="Responsável por imprimir mensagens de debug na tela.">APOSDEBUG</a>(<a class="code" href="Fat_8c.html#fb6a77f8fd1dc0be5fb353a7c656387f" title="Variavel que ativa o modo debug, se seu valor for TRUE(1) e desativa se for FALSE(0)...">debugVariable</a>, <span class="stringliteral">"Problema ao formatar o disco .... \n"</span>);
<a name="l00087"></a>00087                         }
<a name="l00088"></a>00088                 }
<a name="l00089"></a>00089         }
<a name="l00090"></a>00090         <a class="code" href="Scrn_8h.html#273a809d3de4626e50ad4ecd05c44754" title="Responsável por imprimir mensagens de debug na tela.">APOSDEBUG</a>(<a class="code" href="Fat_8c.html#fb6a77f8fd1dc0be5fb353a7c656387f" title="Variavel que ativa o modo debug, se seu valor for TRUE(1) e desativa se for FALSE(0)...">debugVariable</a>, <span class="stringliteral">"todo os ja dispositivos foram carregados ...\n"</span>);
<a name="l00091"></a>00091         <span class="keywordflow">return</span> <a class="code" href="Defs_8h.html#687984f47d8cce148d1b914d2b79612a" title="Successful exit status.">EXIT_SUCCESS</a>;
<a name="l00092"></a>00092 }
<a name="l00098"></a><a class="code" href="Fat_8h.html#ab5b856bdea33a3bcd6b92b3741190d4">00098</a> <span class="keywordtype">int</span> <a class="code" href="Fat_8c.html#ab5b856bdea33a3bcd6b92b3741190d4" title="Tenta carregar na LBA 0 do dispositivo o BS, do sistema de partição, se não conseguir...">loadFatList</a>(<span class="keywordtype">short</span> <span class="keywordtype">int</span> driveNumber) {
<a name="l00099"></a>00099         <span class="keywordtype">char</span> buffer[512];
<a name="l00100"></a>00100         <span class="keywordtype">int</span> result;
<a name="l00101"></a>00101         <span class="keywordtype">int</span> cluster;
<a name="l00102"></a>00102         <span class="keywordtype">int</span> count;
<a name="l00103"></a>00103         <span class="keywordtype">int</span> hdCount;
<a name="l00104"></a>00104         <span class="keyword">struct </span><a class="code" href="structtBpb.html" title="Esta estrutura que representa os dados guardados no setor de boot da partição.">tBpb</a> bsinfo;
<a name="l00105"></a>00105         <span class="keyword">struct </span><a class="code" href="structdiskAddress.html" title="Estrutura responsável por armazenar o endereço de uma posição do HD.">diskAddress</a> address;
<a name="l00106"></a>00106 
<a name="l00107"></a>00107         hdCount = 0;
<a name="l00108"></a>00108         address.<a class="code" href="structdiskAddress.html#dc9405f2e4d862f336366d5e513a3240">error</a> = 0;
<a name="l00109"></a>00109 
<a name="l00110"></a>00110         <a class="code" href="Scrn_8h.html#273a809d3de4626e50ad4ecd05c44754" title="Responsável por imprimir mensagens de debug na tela.">APOSDEBUG</a>(<a class="code" href="Fat_8c.html#fb6a77f8fd1dc0be5fb353a7c656387f" title="Variavel que ativa o modo debug, se seu valor for TRUE(1) e desativa se for FALSE(0)...">debugVariable</a>, <span class="stringliteral">"\n comecando a executar o calcAddress.... \n"</span>);
<a name="l00111"></a>00111         <span class="comment">/*</span>
<a name="l00112"></a>00112 <span class="comment">         * Tenta recuperar  a tabela FAT, que esta gravada no hd,</span>
<a name="l00113"></a>00113 <span class="comment">         * primeiro tenta carregar o setor de boot(bs), depois</span>
<a name="l00114"></a>00114 <span class="comment">         * a FAT, caso tenha sucesso em carregar o BS.</span>
<a name="l00115"></a>00115 <span class="comment">         */</span>
<a name="l00116"></a>00116         <a class="code" href="Scrn_8h.html#273a809d3de4626e50ad4ecd05c44754" title="Responsável por imprimir mensagens de debug na tela.">APOSDEBUG</a>(<a class="code" href="Fat_8c.html#fb6a77f8fd1dc0be5fb353a7c656387f" title="Variavel que ativa o modo debug, se seu valor for TRUE(1) e desativa se for FALSE(0)...">debugVariable</a>, <span class="stringliteral">"\n comecando a executar o loadList.... \n"</span>);
<a name="l00117"></a>00117         <span class="comment">//Ler a região zero da partição e pega o bs que deve está gravado lá, no caso da</span>
<a name="l00118"></a>00118         <span class="comment">//partição já ter sido formatada posteriormente.</span>
<a name="l00119"></a>00119         <span class="comment">/*</span>
<a name="l00120"></a>00120 <span class="comment">         * Essa função calcula através do LBA o endereço. O valor 1 é passado de </span>
<a name="l00121"></a>00121 <span class="comment">         * forma estática pois a BS, deve esta contida em apenas 1 setor.</span>
<a name="l00122"></a>00122 <span class="comment">         */</span>
<a name="l00123"></a>00123 
<a name="l00124"></a>00124         address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a> = 0;
<a name="l00125"></a>00125         result = <a class="code" href="Fat_8c.html#6c3231707b55e1e8cc48a1e7923839da" title="Pegar o valor da LBA*, e calcula o endereço do HD.">calcAddress</a>(driveNumber, &amp;address);
<a name="l00126"></a>00126         <a class="code" href="Ide_8c.html#49f300dd0c1649ae2c02f98f021592a6" title="Ler informações no disco.">readDisk</a>(driveNumber, &amp;address, buffer);
<a name="l00127"></a>00127         <a class="code" href="Slib_8h.html#82c26cd350df88414f825bca40183ec2">memcpy</a>(&amp;bsinfo, buffer, 512);
<a name="l00128"></a>00128         <span class="keywordflow">if</span> (result == 0) {
<a name="l00129"></a>00129                 <span class="keywordflow">if</span> (bsinfo.<a class="code" href="structtBpb.html#1ccf1816f87aed7b24209a7815bf91cb">BS_VolID</a> == 2) {
<a name="l00130"></a>00130                         <a class="code" href="Scrn_8h.html#273a809d3de4626e50ad4ecd05c44754" title="Responsável por imprimir mensagens de debug na tela.">APOSDEBUG</a>(<a class="code" href="Fat_8c.html#fb6a77f8fd1dc0be5fb353a7c656387f" title="Variavel que ativa o modo debug, se seu valor for TRUE(1) e desativa se for FALSE(0)...">debugVariable</a>, <span class="stringliteral">"informacoes do HD consistentes.... \n"</span>);
<a name="l00131"></a>00131                         <span class="comment">//VolumesListed[driveNumber].fatList = &amp;fat[0];</span>
<a name="l00132"></a>00132                         <span class="comment">//Incrementa o hdCount para ele começar a ler os blocos que guardam a FAT</span>
<a name="l00133"></a>00133                         hdCount++;
<a name="l00134"></a>00134                         count = 0;<span class="comment">//zera o count. </span>
<a name="l00135"></a>00135                         cluster = bsinfo.<a class="code" href="structtBpb.html#54657f0a51b31ea2cd2a53a16d98ea10">BPB_FATSz16</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> int)
<a name="l00136"></a>00136                                         / (bsinfo.<a class="code" href="structtBpb.html#9cd180897deee245ef75b0cdd692c408">BPB_BytsPerSec</a> * bsinfo.<a class="code" href="structtBpb.html#7e418eaa426534b3a9853604bc554411">BPB_SecPerClus</a>);
<a name="l00137"></a>00137                         <span class="keywordflow">if</span> (bsinfo.<a class="code" href="structtBpb.html#54657f0a51b31ea2cd2a53a16d98ea10">BPB_FATSz16</a> % (bsinfo.<a class="code" href="structtBpb.html#7e418eaa426534b3a9853604bc554411">BPB_SecPerClus</a> * 512)) {
<a name="l00138"></a>00138                                 cluster = cluster + 1;
<a name="l00139"></a>00139                         }
<a name="l00140"></a>00140                         <span class="comment">//Passamos 1 de forma fixa para lba, pois sempre consideremos que</span>
<a name="l00141"></a>00141                         <span class="comment">//toda FAT começa a no LBA 1 e termina do LBA 257(ou seja ela sempre</span>
<a name="l00142"></a>00142                         <span class="comment">// tem o tamanho de 256)</span>
<a name="l00143"></a>00143                         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> position = 0;
<a name="l00144"></a>00144                         <span class="keywordflow">for</span> (count = 0; count &lt; cluster; count++) {
<a name="l00145"></a>00145                                 address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a> = count + 1;
<a name="l00146"></a>00146                                 <a class="code" href="Fat_8c.html#6c3231707b55e1e8cc48a1e7923839da" title="Pegar o valor da LBA*, e calcula o endereço do HD.">calcAddress</a>(driveNumber, &amp;address);
<a name="l00147"></a>00147                                 result = <a class="code" href="Ide_8c.html#49f300dd0c1649ae2c02f98f021592a6" title="Ler informações no disco.">readDisk</a>(driveNumber, &amp;address, buffer);
<a name="l00148"></a>00148                                 <a class="code" href="Slib_8h.html#82c26cd350df88414f825bca40183ec2">memcpy</a>((<span class="keywordtype">void</span> *) &amp;VolumesListed[driveNumber].fatList[position],
<a name="l00149"></a>00149                                                 (<span class="keywordtype">void</span> *)buffer, 512);
<a name="l00150"></a>00150                                 position = position + 256;
<a name="l00151"></a>00151                         }
<a name="l00152"></a>00152                         <span class="comment">//Colocando o ponteiro de fatPos para apontar para o cluster do </span>
<a name="l00153"></a>00153                         <span class="comment">//raiz do sistema.                      </span>
<a name="l00154"></a>00154                         VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#efee485164fbf8d4048a0e53d7a16310">fatPos</a> = bsinfo.<a class="code" href="structtBpb.html#25cef46c56c24e23072a91c4e783abd0">BPB_RootClus</a>;
<a name="l00155"></a>00155                         <span class="comment">//Carregando o valor da LBL</span>
<a name="l00156"></a>00156                         VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#12b2937b5c7692c9c00148163a5d699f">LBL</a> = bsinfo.<a class="code" href="structtBpb.html#9ebfb91c241b20fa39f2f0fdfdbc01f0">BPB_LBL</a>;
<a name="l00157"></a>00157                         address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a> = VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#efee485164fbf8d4048a0e53d7a16310">fatPos</a>;
<a name="l00158"></a>00158                         <a class="code" href="Fat_8c.html#6c3231707b55e1e8cc48a1e7923839da" title="Pegar o valor da LBA*, e calcula o endereço do HD.">calcAddress</a>(driveNumber, &amp;address);
<a name="l00159"></a>00159                         <span class="comment">//Lemos do HD, o conteudo apontado pela posição atual da FAT e</span>
<a name="l00160"></a>00160                         <span class="comment">//guardamos ele em actualDirectory.</span>
<a name="l00161"></a>00161                         result = <a class="code" href="Ide_8c.html#49f300dd0c1649ae2c02f98f021592a6" title="Ler informações no disco.">readDisk</a>(driveNumber, &amp;address, buffer);
<a name="l00162"></a>00162                         VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#eda5a7c1a9a78740fcd1029544c08a3d">actualDirectory</a>
<a name="l00163"></a>00163                                         = *((<span class="keyword">struct </span><a class="code" href="structfatDirectory.html" title="Estrutura que representa as entradas de um diretório.">fatDirectory</a> *) buffer);
<a name="l00164"></a>00164                         VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#14605661c88f332ddd66ec510fe1d90c">bs</a> = bsinfo;
<a name="l00165"></a>00165                         VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#eda5a7c1a9a78740fcd1029544c08a3d">actualDirectory</a>.<a class="code" href="structfatDirectory.html#c0cc3c681cc7daddcd54257becc6b2dd">startCluster</a>
<a name="l00166"></a>00166                                         = VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#14605661c88f332ddd66ec510fe1d90c">bs</a>.<a class="code" href="structtBpb.html#25cef46c56c24e23072a91c4e783abd0">BPB_RootClus</a>;
<a name="l00167"></a>00167                 } <span class="keywordflow">else</span> {
<a name="l00168"></a>00168                         <span class="comment">//APOSDEBUG(debugVariable,"informacoes lidas do HD nao sao consistentes,precisamos formanta-la...\n");</span>
<a name="l00169"></a>00169                         <span class="keywordflow">return</span> <a class="code" href="Defs_8h.html#73efe787c131b385070f25d18b7c9aa4" title="Failing exit status.">EXIT_FAILURE</a>;
<a name="l00170"></a>00170                 }
<a name="l00171"></a>00171         } <span class="keywordflow">else</span> {
<a name="l00172"></a>00172                 <a class="code" href="Scrn_8h.html#273a809d3de4626e50ad4ecd05c44754" title="Responsável por imprimir mensagens de debug na tela.">APOSDEBUG</a>(<a class="code" href="Fat_8c.html#fb6a77f8fd1dc0be5fb353a7c656387f" title="Variavel que ativa o modo debug, se seu valor for TRUE(1) e desativa se for FALSE(0)...">debugVariable</a>, <span class="stringliteral">"erro na leitura do HD"</span>);
<a name="l00173"></a>00173 
<a name="l00174"></a>00174         }
<a name="l00175"></a>00175         <a class="code" href="Scrn_8h.html#273a809d3de4626e50ad4ecd05c44754" title="Responsável por imprimir mensagens de debug na tela.">APOSDEBUG</a>(<a class="code" href="Fat_8c.html#fb6a77f8fd1dc0be5fb353a7c656387f" title="Variavel que ativa o modo debug, se seu valor for TRUE(1) e desativa se for FALSE(0)...">debugVariable</a>, <span class="stringliteral">"fim de loadList...\n"</span>);
<a name="l00176"></a>00176         <span class="keywordflow">return</span> <a class="code" href="Defs_8h.html#687984f47d8cce148d1b914d2b79612a" title="Successful exit status.">EXIT_SUCCESS</a>;
<a name="l00177"></a>00177 }
<a name="l00183"></a><a class="code" href="KFat_8h.html#9588e166a75e2559d64aa27132b5e28f">00183</a> <span class="keywordtype">int</span> <a class="code" href="Fat_8c.html#9588e166a75e2559d64aa27132b5e28f" title="Fomata o disco, no sistema de partição AFS2.0, criando uma bs e um Fat para ele...">formatDisk</a>(<span class="keywordtype">short</span> <span class="keywordtype">int</span> driveNumber) {
<a name="l00184"></a>00184         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <span class="keywordtype">int</span> count;
<a name="l00185"></a>00185         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <span class="keywordtype">int</span> cluster;
<a name="l00186"></a>00186         <span class="keyword">struct </span><a class="code" href="structtBpb.html" title="Esta estrutura que representa os dados guardados no setor de boot da partição.">tBpb</a> bs;
<a name="l00187"></a>00187         <span class="keywordtype">char</span> buffer[512];
<a name="l00188"></a>00188         <span class="keywordtype">char</span> fatBuffer[512];
<a name="l00189"></a>00189         <span class="keyword">struct </span><a class="code" href="structdiskAddress.html" title="Estrutura responsável por armazenar o endereço de uma posição do HD.">diskAddress</a> address;
<a name="l00190"></a>00190 
<a name="l00191"></a>00191         bs.<a class="code" href="structtBpb.html#54657f0a51b31ea2cd2a53a16d98ea10">BPB_FATSz16</a> = <a class="code" href="FatDefs_8h.html#a551ec3e8bfdf08d8442ef55d3deb200">PARTITIONMAXSIZE</a>;
<a name="l00192"></a>00192 
<a name="l00193"></a>00193         <span class="comment">//Inicializando os valores da BS.</span>
<a name="l00194"></a>00194         bs.<a class="code" href="structtBpb.html#9cd180897deee245ef75b0cdd692c408">BPB_BytsPerSec</a> = 512;
<a name="l00195"></a>00195         bs.<a class="code" href="structtBpb.html#4e8e7e3cc1e74757bdff3c781b5fce0b">BPB_FSVer</a> = 1;
<a name="l00196"></a>00196         bs.<a class="code" href="structtBpb.html#86a37743557f6b25fcd614ca0080d2f0">BPB_Media</a> = <span class="charliteral">'f'</span>;
<a name="l00197"></a>00197         bs.<a class="code" href="structtBpb.html#9a36cb60f21c4f3e0a30949c605a7d3d">BPB_NumFATs</a> = 1;
<a name="l00198"></a>00198         bs.<a class="code" href="structtBpb.html#22dd409111c0715f991089a717200cbe">BPB_NumHeads</a> = <a class="code" href="Ide_8c.html#a576f9e371be3de5d0abe403b8369ae1" title="Retornar a quantidade de cabeçalhos de um hd.">getDiskHeads</a>(driveNumber);
<a name="l00199"></a>00199         bs.<a class="code" href="structtBpb.html#c3817570c4a21279f8c08382d220a2b2">BPB_ResvdSecCnt</a> = 0;
<a name="l00200"></a>00200         bs.<a class="code" href="structtBpb.html#7e418eaa426534b3a9853604bc554411">BPB_SecPerClus</a> = 1;
<a name="l00201"></a>00201         bs.<a class="code" href="structtBpb.html#f9ea37e17eb55c7a66958810a682c031">BPB_SecPerTrk</a> = <a class="code" href="Ide_8c.html#142511891c2876bd8b63491ce80b90bd" title="Retornar a quantidade de setores por trilha de um hd.">getDiskSectorsPerTrack</a>(driveNumber);
<a name="l00202"></a>00202         bs.<a class="code" href="structtBpb.html#8515701c8b62d5d5961f75a520b79d5d">BPB_TotSec16</a> = <a class="code" href="Ide_8c.html#142511891c2876bd8b63491ce80b90bd" title="Retornar a quantidade de setores por trilha de um hd.">getDiskSectorsPerTrack</a>(driveNumber)
<a name="l00203"></a>00203                         * <a class="code" href="Ide_8c.html#a576f9e371be3de5d0abe403b8369ae1" title="Retornar a quantidade de cabeçalhos de um hd.">getDiskHeads</a>(driveNumber) * <a class="code" href="Ide_8c.html#df28570c3a70c15746a81ea2628652e9" title="Retornar a quantidade de cilindros de um hd.">getDiskCylinders</a>(driveNumber);
<a name="l00204"></a>00204         bs.<a class="code" href="structtBpb.html#72210d38ff3d31e6994ef18d6ccc2df3">BS_BootSig</a> = 0x29;
<a name="l00205"></a>00205         bs.<a class="code" href="structtBpb.html#3107630aa9883bbb87588195c4f44969">BS_DrvNum</a> = driveNumber;
<a name="l00206"></a>00206         bs.<a class="code" href="structtBpb.html#6e8f2e628c29aae29321d4ff44c3dc4e">BS_FilSysType</a>[0] = <span class="charliteral">'a'</span>;
<a name="l00207"></a>00207         bs.<a class="code" href="structtBpb.html#6e8f2e628c29aae29321d4ff44c3dc4e">BS_FilSysType</a>[1] = <span class="charliteral">'f'</span>;
<a name="l00208"></a>00208         bs.<a class="code" href="structtBpb.html#6e8f2e628c29aae29321d4ff44c3dc4e">BS_FilSysType</a>[2] = <span class="charliteral">'s'</span>;
<a name="l00209"></a>00209         bs.<a class="code" href="structtBpb.html#bc4b3329275fd3b99f0c4d3076fe0446">BS_OEMName</a>[0] = <span class="charliteral">'a'</span>;
<a name="l00210"></a>00210         bs.<a class="code" href="structtBpb.html#bc4b3329275fd3b99f0c4d3076fe0446">BS_OEMName</a>[1] = <span class="charliteral">'p'</span>;
<a name="l00211"></a>00211         bs.<a class="code" href="structtBpb.html#bc4b3329275fd3b99f0c4d3076fe0446">BS_OEMName</a>[2] = <span class="charliteral">'o'</span>;
<a name="l00212"></a>00212         bs.<a class="code" href="structtBpb.html#bc4b3329275fd3b99f0c4d3076fe0446">BS_OEMName</a>[3] = <span class="charliteral">'s'</span>;
<a name="l00213"></a>00213         bs.<a class="code" href="structtBpb.html#907179ba51db7ecf0654fa32c44bd3f6">BS_Reserved2</a> = <span class="charliteral">'0'</span>;
<a name="l00214"></a>00214         bs.<a class="code" href="structtBpb.html#1ccf1816f87aed7b24209a7815bf91cb">BS_VolID</a> = 2;
<a name="l00215"></a>00215         bs.<a class="code" href="structtBpb.html#a3794b9e67676f7e9f7da85d5144de5d">BS_VolLab</a>[0] = <span class="charliteral">'c'</span>;
<a name="l00216"></a>00216         bs.<a class="code" href="structtBpb.html#730daeafc817ebd41304bdf9de55054b">BS_jmpBoot</a>[0] = <span class="charliteral">'a'</span>;
<a name="l00217"></a>00217         <a class="code" href="Scrn_8h.html#273a809d3de4626e50ad4ecd05c44754" title="Responsável por imprimir mensagens de debug na tela.">APOSDEBUG</a>(<a class="code" href="Fat_8c.html#fb6a77f8fd1dc0be5fb353a7c656387f" title="Variavel que ativa o modo debug, se seu valor for TRUE(1) e desativa se for FALSE(0)...">debugVariable</a>, <span class="stringliteral">"Inicializando Fat \n "</span>);
<a name="l00218"></a>00218 
<a name="l00219"></a>00219         <span class="comment">//inicialza o cluster, atravez da  variavel BPB_FATSz16, que contem a quantidade maxima de cluster que a partição pode ter.</span>
<a name="l00220"></a>00220         cluster = bs.<a class="code" href="structtBpb.html#54657f0a51b31ea2cd2a53a16d98ea10">BPB_FATSz16</a>;
<a name="l00221"></a>00221         count = 1;
<a name="l00222"></a>00222 
<a name="l00223"></a>00223         <span class="keywordflow">while</span> (count &lt; cluster) {
<a name="l00224"></a>00224                 VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#fd575cf6e0eb42eb1e1bd61617d9494d">fatList</a>[count] = count + 1;
<a name="l00225"></a>00225                 count++;
<a name="l00226"></a>00226         }
<a name="l00227"></a>00227 
<a name="l00228"></a>00228         VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#fd575cf6e0eb42eb1e1bd61617d9494d">fatList</a>[count] = <a class="code" href="FatDefs_8h.html#b6ad368e32c6304728c863dbb1e9d8dd">EOC</a>;
<a name="l00229"></a>00229 
<a name="l00230"></a>00230         <span class="comment">//gravando FAT no HD</span>
<a name="l00231"></a>00231         <span class="comment">/*</span>
<a name="l00232"></a>00232 <span class="comment">         * Pegamos o numero total de setores listados pelo sistema de arquivos,</span>
<a name="l00233"></a>00233 <span class="comment">         * multiplicamos pelo tamanho de cada um, e depois dividimos pela capacidade</span>
<a name="l00234"></a>00234 <span class="comment">         * de cada cluster, para saber quantos cluster teremos de usar para guardar</span>
<a name="l00235"></a>00235 <span class="comment">         * os arquivos.</span>
<a name="l00236"></a>00236 <span class="comment">         */</span>
<a name="l00237"></a>00237 
<a name="l00238"></a>00238         <a class="code" href="Scrn_8h.html#273a809d3de4626e50ad4ecd05c44754" title="Responsável por imprimir mensagens de debug na tela.">APOSDEBUG</a>(<a class="code" href="Fat_8c.html#fb6a77f8fd1dc0be5fb353a7c656387f" title="Variavel que ativa o modo debug, se seu valor for TRUE(1) e desativa se for FALSE(0)...">debugVariable</a>, <span class="stringliteral">"Preparando para gravar FAT \n"</span>);
<a name="l00239"></a>00239         cluster = bs.<a class="code" href="structtBpb.html#54657f0a51b31ea2cd2a53a16d98ea10">BPB_FATSz16</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> int)/ (bs.<a class="code" href="structtBpb.html#7e418eaa426534b3a9853604bc554411">BPB_SecPerClus</a>
<a name="l00240"></a>00240                         * bs.<a class="code" href="structtBpb.html#9cd180897deee245ef75b0cdd692c408">BPB_BytsPerSec</a>);
<a name="l00241"></a>00241         <a class="code" href="Scrn_8h.html#273a809d3de4626e50ad4ecd05c44754" title="Responsável por imprimir mensagens de debug na tela.">APOSDEBUG</a>(<a class="code" href="Fat_8c.html#fb6a77f8fd1dc0be5fb353a7c656387f" title="Variavel que ativa o modo debug, se seu valor for TRUE(1) e desativa se for FALSE(0)...">debugVariable</a>, <span class="stringliteral">"\n"</span>);
<a name="l00242"></a>00242         <span class="keywordflow">if</span> (bs.<a class="code" href="structtBpb.html#54657f0a51b31ea2cd2a53a16d98ea10">BPB_FATSz16</a> % (((<span class="keywordtype">int</span>)bs.<a class="code" href="structtBpb.html#7e418eaa426534b3a9853604bc554411">BPB_SecPerClus</a>) * 512)) {
<a name="l00243"></a>00243                 cluster = cluster + 1;
<a name="l00244"></a>00244         }
<a name="l00245"></a>00245 
<a name="l00246"></a>00246         <span class="comment">//Passamos primeiro da forma fixa, para lba, pois sempre consideremos que</span>
<a name="l00247"></a>00247         <span class="comment">//toda FAT começa a no LBA 1 e termina do LBA 257(ou seja ela sempre</span>
<a name="l00248"></a>00248         <span class="comment">// tem o tamanho de 256)</span>
<a name="l00249"></a>00249         <a class="code" href="Scrn_8h.html#273a809d3de4626e50ad4ecd05c44754" title="Responsável por imprimir mensagens de debug na tela.">APOSDEBUG</a>(<a class="code" href="Fat_8c.html#fb6a77f8fd1dc0be5fb353a7c656387f" title="Variavel que ativa o modo debug, se seu valor for TRUE(1) e desativa se for FALSE(0)...">debugVariable</a>, <span class="stringliteral">"Gravando FAT \n"</span>);
<a name="l00250"></a>00250 
<a name="l00251"></a>00251         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> position = 0;
<a name="l00252"></a>00252         VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#fd575cf6e0eb42eb1e1bd61617d9494d">fatList</a>[cluster + 2] = <a class="code" href="FatDefs_8h.html#b6ad368e32c6304728c863dbb1e9d8dd">EOC</a>;
<a name="l00253"></a>00253         <span class="keywordflow">for</span> (count = 0; count &lt; cluster; count++) {
<a name="l00254"></a>00254 
<a name="l00255"></a>00255                 address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a> = count + 1;
<a name="l00256"></a>00256 
<a name="l00257"></a>00257                 <a class="code" href="Fat_8c.html#6c3231707b55e1e8cc48a1e7923839da" title="Pegar o valor da LBA*, e calcula o endereço do HD.">calcAddress</a>(driveNumber, &amp;address);
<a name="l00258"></a>00258 
<a name="l00259"></a>00259                 <a class="code" href="Slib_8h.html#82c26cd350df88414f825bca40183ec2">memcpy</a>((<span class="keywordtype">void</span> *) fatBuffer,
<a name="l00260"></a>00260                                 (<span class="keywordtype">void</span> *) &amp;VolumesListed[driveNumber].fatList[position], 512);
<a name="l00261"></a>00261                 <a class="code" href="Ide_8c.html#a50554702a6b831c05346509d3a8bdc6" title="Grava informações no disco.">writeDisk</a>(driveNumber, &amp;address, fatBuffer);
<a name="l00262"></a>00262                 position= position + 256;
<a name="l00263"></a>00263         }
<a name="l00264"></a>00264 
<a name="l00265"></a>00265         <a class="code" href="Scrn_8h.html#273a809d3de4626e50ad4ecd05c44754" title="Responsável por imprimir mensagens de debug na tela.">APOSDEBUG</a>(<a class="code" href="Fat_8c.html#fb6a77f8fd1dc0be5fb353a7c656387f" title="Variavel que ativa o modo debug, se seu valor for TRUE(1) e desativa se for FALSE(0)...">debugVariable</a>, <span class="stringliteral">"FAT gravada \n"</span>);
<a name="l00266"></a>00266         <span class="comment">//O números de setores escondidos recebe 1 do BS, mais o número de cluster ocupado pela Fat.</span>
<a name="l00267"></a>00267         bs.<a class="code" href="structtBpb.html#81f43dedc6f14f391381ae3cc8d16e60">BPB_HiddSec</a> = 1 + cluster;
<a name="l00268"></a>00268         <a class="code" href="Scrn_8h.html#273a809d3de4626e50ad4ecd05c44754" title="Responsável por imprimir mensagens de debug na tela.">APOSDEBUG</a>(<a class="code" href="Fat_8c.html#fb6a77f8fd1dc0be5fb353a7c656387f" title="Variavel que ativa o modo debug, se seu valor for TRUE(1) e desativa se for FALSE(0)...">debugVariable</a>, <span class="stringliteral">" valor do hiddsec = "</span>);
<a name="l00269"></a>00269         <a class="code" href="Scrn_8h.html#3b47c20d8bb9e5c9d3cd0137c247ed81" title="Imprime na tela um inteiro.">printfInt</a>(bs.<a class="code" href="structtBpb.html#81f43dedc6f14f391381ae3cc8d16e60">BPB_HiddSec</a>);
<a name="l00270"></a>00270         <a class="code" href="Scrn_8h.html#273a809d3de4626e50ad4ecd05c44754" title="Responsável por imprimir mensagens de debug na tela.">APOSDEBUG</a>(<a class="code" href="Fat_8c.html#fb6a77f8fd1dc0be5fb353a7c656387f" title="Variavel que ativa o modo debug, se seu valor for TRUE(1) e desativa se for FALSE(0)...">debugVariable</a>, <span class="stringliteral">"\n"</span>);
<a name="l00271"></a>00271         <span class="comment">//O cluster do root é primeiro logo depois dos setores reservados para o BS + FAT</span>
<a name="l00272"></a>00272         bs.<a class="code" href="structtBpb.html#25cef46c56c24e23072a91c4e783abd0">BPB_RootClus</a> = bs.<a class="code" href="structtBpb.html#81f43dedc6f14f391381ae3cc8d16e60">BPB_HiddSec</a> + 1;
<a name="l00273"></a>00273         bs.<a class="code" href="structtBpb.html#9ebfb91c241b20fa39f2f0fdfdbc01f0">BPB_LBL</a> = bs.<a class="code" href="structtBpb.html#25cef46c56c24e23072a91c4e783abd0">BPB_RootClus</a> + 1;
<a name="l00274"></a>00274         <span class="comment">//gravando BS no HD</span>
<a name="l00275"></a>00275         VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#14605661c88f332ddd66ec510fe1d90c">bs</a> = bs;
<a name="l00276"></a>00276         <a class="code" href="Scrn_8h.html#273a809d3de4626e50ad4ecd05c44754" title="Responsável por imprimir mensagens de debug na tela.">APOSDEBUG</a>(<a class="code" href="Fat_8c.html#fb6a77f8fd1dc0be5fb353a7c656387f" title="Variavel que ativa o modo debug, se seu valor for TRUE(1) e desativa se for FALSE(0)...">debugVariable</a>,
<a name="l00277"></a>00277                         <span class="stringliteral">"Passando as inforacoes da bs para a instancia na memoria \n"</span>);
<a name="l00278"></a>00278 
<a name="l00279"></a>00279         <span class="comment">//buffer = (char *) &amp;bs;</span>
<a name="l00280"></a>00280         <a class="code" href="Slib_8h.html#82c26cd350df88414f825bca40183ec2">memcpy</a>(buffer, &amp;bs, 512);
<a name="l00281"></a>00281         address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a> = 0;
<a name="l00282"></a>00282         <a class="code" href="Fat_8c.html#6c3231707b55e1e8cc48a1e7923839da" title="Pegar o valor da LBA*, e calcula o endereço do HD.">calcAddress</a>(driveNumber, &amp;address);
<a name="l00283"></a>00283         <a class="code" href="Scrn_8h.html#273a809d3de4626e50ad4ecd05c44754" title="Responsável por imprimir mensagens de debug na tela.">APOSDEBUG</a>(<a class="code" href="Fat_8c.html#fb6a77f8fd1dc0be5fb353a7c656387f" title="Variavel que ativa o modo debug, se seu valor for TRUE(1) e desativa se for FALSE(0)...">debugVariable</a>, <span class="stringliteral">"Gravando bbs no HD \n"</span>);
<a name="l00284"></a>00284         <a class="code" href="Ide_8c.html#a50554702a6b831c05346509d3a8bdc6" title="Grava informações no disco.">writeDisk</a>(driveNumber, &amp;address, buffer);
<a name="l00285"></a>00285         <a class="code" href="Scrn_8h.html#273a809d3de4626e50ad4ecd05c44754" title="Responsável por imprimir mensagens de debug na tela.">APOSDEBUG</a>(<a class="code" href="Fat_8c.html#fb6a77f8fd1dc0be5fb353a7c656387f" title="Variavel que ativa o modo debug, se seu valor for TRUE(1) e desativa se for FALSE(0)...">debugVariable</a>, <span class="stringliteral">"Bs gravada no HD \n"</span>);
<a name="l00286"></a>00286         <span class="comment">//Apos a formatação do volume, o primeiro espaço disponível é o primeiro cluster dois do cluster do root.</span>
<a name="l00287"></a>00287         <a class="code" href="Scrn_8h.html#273a809d3de4626e50ad4ecd05c44754" title="Responsável por imprimir mensagens de debug na tela.">APOSDEBUG</a>(<a class="code" href="Fat_8c.html#fb6a77f8fd1dc0be5fb353a7c656387f" title="Variavel que ativa o modo debug, se seu valor for TRUE(1) e desativa se for FALSE(0)...">debugVariable</a>, <span class="stringliteral">"Achando lbl e o cluster root \n"</span>);
<a name="l00288"></a>00288         VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#12b2937b5c7692c9c00148163a5d699f">LBL</a> = VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#14605661c88f332ddd66ec510fe1d90c">bs</a>.<a class="code" href="structtBpb.html#9ebfb91c241b20fa39f2f0fdfdbc01f0">BPB_LBL</a>;
<a name="l00289"></a>00289         VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#efee485164fbf8d4048a0e53d7a16310">fatPos</a>
<a name="l00290"></a>00290                         = VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#14605661c88f332ddd66ec510fe1d90c">bs</a>.<a class="code" href="structtBpb.html#25cef46c56c24e23072a91c4e783abd0">BPB_RootClus</a>;
<a name="l00291"></a>00291 
<a name="l00292"></a>00292         <span class="comment">//Inicializando valores do root enteryDirectory</span>
<a name="l00293"></a>00293         <span class="comment">//será inicializado de inicio apenas os valores de estatus, pois é le que diz</span>
<a name="l00294"></a>00294         <span class="comment">//se existe ou não algum arquivo (1 = existe e 0 = não existe).</span>
<a name="l00295"></a>00295 
<a name="l00296"></a>00296         <span class="keyword">struct </span><a class="code" href="structfatDirectory.html" title="Estrutura que representa as entradas de um diretório.">fatDirectory</a> rootDir[16];
<a name="l00297"></a>00297 
<a name="l00298"></a>00298         <span class="keywordflow">for</span> (count = 0; count &lt; 16; count++) {
<a name="l00299"></a>00299                 rootDir[count].<a class="code" href="structfatDirectory.html#16fb47757a9786affc18f93576abdb58">attribute</a>.<a class="code" href="structAttribute.html#8a29ec3705c795db68ce2a64aebd2c48">status</a> = <a class="code" href="FatDefs_8h.html#ef5bc51f67c258e3de36353bc58c3dd7">unchecked</a>;
<a name="l00300"></a>00300         }
<a name="l00301"></a>00301 
<a name="l00302"></a>00302         <a class="code" href="Slib_8h.html#82c26cd350df88414f825bca40183ec2">memcpy</a>((<span class="keywordtype">void</span> *) buffer, (<span class="keywordtype">void</span> *) &amp;rootDir, 512);
<a name="l00303"></a>00303 
<a name="l00304"></a>00304         address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a> = VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#efee485164fbf8d4048a0e53d7a16310">fatPos</a>;
<a name="l00305"></a>00305         <a class="code" href="Scrn_8h.html#273a809d3de4626e50ad4ecd05c44754" title="Responsável por imprimir mensagens de debug na tela.">APOSDEBUG</a>(<a class="code" href="Fat_8c.html#fb6a77f8fd1dc0be5fb353a7c656387f" title="Variavel que ativa o modo debug, se seu valor for TRUE(1) e desativa se for FALSE(0)...">debugVariable</a>,
<a name="l00306"></a>00306                         <span class="stringliteral">"Carregando root para actualDirectory e gravando no hd \n"</span>);
<a name="l00307"></a>00307         <span class="comment">//gravando os valores do root entryDirectory</span>
<a name="l00308"></a>00308         <a class="code" href="Fat_8c.html#6c3231707b55e1e8cc48a1e7923839da" title="Pegar o valor da LBA*, e calcula o endereço do HD.">calcAddress</a>(driveNumber, &amp;address);
<a name="l00309"></a>00309         <span class="comment">//gava as informações de rootDir no hd</span>
<a name="l00310"></a>00310         <a class="code" href="Ide_8c.html#a50554702a6b831c05346509d3a8bdc6" title="Grava informações no disco.">writeDisk</a>(driveNumber, &amp;address, buffer);
<a name="l00311"></a>00311 
<a name="l00312"></a>00312         <a class="code" href="Scrn_8h.html#273a809d3de4626e50ad4ecd05c44754" title="Responsável por imprimir mensagens de debug na tela.">APOSDEBUG</a>(<a class="code" href="Fat_8c.html#fb6a77f8fd1dc0be5fb353a7c656387f" title="Variavel que ativa o modo debug, se seu valor for TRUE(1) e desativa se for FALSE(0)...">debugVariable</a>,
<a name="l00313"></a>00313                         <span class="stringliteral">"dados de actualDiretory gravado, agora sendo inicializado. \n"</span>);
<a name="l00314"></a>00314         VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#eda5a7c1a9a78740fcd1029544c08a3d">actualDirectory</a>.<a class="code" href="structfatDirectory.html#c0cc3c681cc7daddcd54257becc6b2dd">startCluster</a>
<a name="l00315"></a>00315                         = VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#efee485164fbf8d4048a0e53d7a16310">fatPos</a>;
<a name="l00316"></a>00316         VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#eda5a7c1a9a78740fcd1029544c08a3d">actualDirectory</a>.<a class="code" href="structfatDirectory.html#4bea39f8d6c526ccab754274c10ea0d5">fileSize</a> = 32;
<a name="l00317"></a>00317         VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#eda5a7c1a9a78740fcd1029544c08a3d">actualDirectory</a>.<a class="code" href="structfatDirectory.html#16fb47757a9786affc18f93576abdb58">attribute</a>.<a class="code" href="structAttribute.html#352bfa638e4fe8f173f36479e6afb284">directory</a> = <a class="code" href="FatDefs_8h.html#e17eeb06f496b8ec152d32a5aa746482">checked</a>;
<a name="l00318"></a>00318         VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#eda5a7c1a9a78740fcd1029544c08a3d">actualDirectory</a>.<a class="code" href="structfatDirectory.html#16fb47757a9786affc18f93576abdb58">attribute</a>.<a class="code" href="structAttribute.html#1e9b5af14a50071b88f2c45ca12e6fc0">file</a> = <a class="code" href="FatDefs_8h.html#ef5bc51f67c258e3de36353bc58c3dd7">unchecked</a>;
<a name="l00319"></a>00319         VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#eda5a7c1a9a78740fcd1029544c08a3d">actualDirectory</a>.<a class="code" href="structfatDirectory.html#16fb47757a9786affc18f93576abdb58">attribute</a>.<a class="code" href="structAttribute.html#8a29ec3705c795db68ce2a64aebd2c48">status</a> = <a class="code" href="FatDefs_8h.html#e17eeb06f496b8ec152d32a5aa746482">checked</a>;
<a name="l00320"></a>00320         VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#eda5a7c1a9a78740fcd1029544c08a3d">actualDirectory</a>.<a class="code" href="structfatDirectory.html#16fb47757a9786affc18f93576abdb58">attribute</a>.<a class="code" href="structAttribute.html#4d96cf5f87e43b02038d890c0d795666">readOnly</a> = <a class="code" href="FatDefs_8h.html#e17eeb06f496b8ec152d32a5aa746482">checked</a>;
<a name="l00321"></a>00321         VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#eda5a7c1a9a78740fcd1029544c08a3d">actualDirectory</a>.<a class="code" href="structfatDirectory.html#16fb47757a9786affc18f93576abdb58">attribute</a>.<a class="code" href="structAttribute.html#e925d1a7dd56c3d9ec27b3dceb6ffeed">system</a> = <a class="code" href="FatDefs_8h.html#e17eeb06f496b8ec152d32a5aa746482">checked</a>;
<a name="l00322"></a>00322         VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#eda5a7c1a9a78740fcd1029544c08a3d">actualDirectory</a>.<a class="code" href="structfatDirectory.html#c0cc3c681cc7daddcd54257becc6b2dd">startCluster</a>
<a name="l00323"></a>00323                         = VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#14605661c88f332ddd66ec510fe1d90c">bs</a>.<a class="code" href="structtBpb.html#25cef46c56c24e23072a91c4e783abd0">BPB_RootClus</a>;
<a name="l00324"></a>00324         <a class="code" href="Scrn_8h.html#273a809d3de4626e50ad4ecd05c44754" title="Responsável por imprimir mensagens de debug na tela.">APOSDEBUG</a>(<a class="code" href="Fat_8c.html#fb6a77f8fd1dc0be5fb353a7c656387f" title="Variavel que ativa o modo debug, se seu valor for TRUE(1) e desativa se for FALSE(0)...">debugVariable</a>,
<a name="l00325"></a>00325                         <span class="stringliteral">" dados de actualDiretory gravado, inicializados. \n"</span>);
<a name="l00326"></a>00326 
<a name="l00327"></a>00327         <span class="keywordflow">return</span> <a class="code" href="Defs_8h.html#687984f47d8cce148d1b914d2b79612a" title="Successful exit status.">EXIT_SUCCESS</a>;
<a name="l00328"></a>00328 }
<a name="l00334"></a><a class="code" href="Fat_8h.html#b2ef313f23df0aeadc3741f16bdcb75f">00334</a> <span class="keywordtype">int</span> <a class="code" href="Fat_8c.html#b2ef313f23df0aeadc3741f16bdcb75f" title="Grava as ultimas modificações da FAT no HD.">updateFat</a>(<span class="keywordtype">int</span> driveNumber) {
<a name="l00335"></a>00335         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <span class="keywordtype">int</span> cluster;
<a name="l00336"></a>00336         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> position;
<a name="l00337"></a>00337         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <span class="keywordtype">int</span> count;
<a name="l00338"></a>00338         <span class="keywordtype">char</span> fatBuffer[512];
<a name="l00339"></a>00339         <span class="keyword">struct </span><a class="code" href="structdiskAddress.html" title="Estrutura responsável por armazenar o endereço de uma posição do HD.">diskAddress</a> address;
<a name="l00340"></a>00340 
<a name="l00341"></a>00341         <span class="comment">//calcula quantos clusters serão necessários para gravar a FAT</span>
<a name="l00342"></a>00342         cluster = VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#14605661c88f332ddd66ec510fe1d90c">bs</a>.<a class="code" href="structtBpb.html#54657f0a51b31ea2cd2a53a16d98ea10">BPB_FATSz16</a>
<a name="l00343"></a>00343                         * <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> int)
<a name="l00344"></a>00344                         / (VolumesListed[driveNumber].bs.BPB_SecPerClus
<a name="l00345"></a>00345                                         * VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#14605661c88f332ddd66ec510fe1d90c">bs</a>.<a class="code" href="structtBpb.html#9cd180897deee245ef75b0cdd692c408">BPB_BytsPerSec</a>);
<a name="l00346"></a>00346 
<a name="l00347"></a>00347         <span class="keywordflow">if</span> (VolumesListed[driveNumber].bs.BPB_FATSz16
<a name="l00348"></a>00348                         % (((<span class="keywordtype">int</span>)VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#14605661c88f332ddd66ec510fe1d90c">bs</a>.<a class="code" href="structtBpb.html#7e418eaa426534b3a9853604bc554411">BPB_SecPerClus</a>) * 512)) {
<a name="l00349"></a>00349                 cluster = cluster + 1;
<a name="l00350"></a>00350         }
<a name="l00351"></a>00351 
<a name="l00352"></a>00352         <a class="code" href="Scrn_8h.html#273a809d3de4626e50ad4ecd05c44754" title="Responsável por imprimir mensagens de debug na tela.">APOSDEBUG</a>(<a class="code" href="Fat_8c.html#fb6a77f8fd1dc0be5fb353a7c656387f" title="Variavel que ativa o modo debug, se seu valor for TRUE(1) e desativa se for FALSE(0)...">debugVariable</a>, <span class="stringliteral">"\n Atualizando FAT \n"</span>);
<a name="l00353"></a>00353 
<a name="l00354"></a>00354         position = 0;
<a name="l00355"></a>00355         <span class="keywordflow">for</span> (count = 0; count &lt; cluster; count++) {
<a name="l00356"></a>00356 
<a name="l00357"></a>00357                 address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a> = count + 1;
<a name="l00358"></a>00358 
<a name="l00359"></a>00359                 <a class="code" href="Fat_8c.html#6c3231707b55e1e8cc48a1e7923839da" title="Pegar o valor da LBA*, e calcula o endereço do HD.">calcAddress</a>(driveNumber, &amp;address);
<a name="l00360"></a>00360 
<a name="l00361"></a>00361                 <a class="code" href="Slib_8h.html#82c26cd350df88414f825bca40183ec2">memcpy</a>((<span class="keywordtype">void</span> *) &amp;fatBuffer[0],
<a name="l00362"></a>00362                                 (<span class="keywordtype">void</span> *) &amp;VolumesListed[driveNumber].fatList[position], 512);
<a name="l00363"></a>00363                 <a class="code" href="Ide_8c.html#a50554702a6b831c05346509d3a8bdc6" title="Grava informações no disco.">writeDisk</a>(driveNumber, &amp;address, fatBuffer);
<a name="l00364"></a>00364                 position = position + 256;
<a name="l00365"></a>00365         }
<a name="l00366"></a>00366 
<a name="l00367"></a>00367         address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a> = 0;
<a name="l00368"></a>00368         <a class="code" href="Fat_8c.html#6c3231707b55e1e8cc48a1e7923839da" title="Pegar o valor da LBA*, e calcula o endereço do HD.">calcAddress</a>(driveNumber, &amp;address);
<a name="l00369"></a>00369         VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#14605661c88f332ddd66ec510fe1d90c">bs</a>.<a class="code" href="structtBpb.html#9ebfb91c241b20fa39f2f0fdfdbc01f0">BPB_LBL</a> = VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#12b2937b5c7692c9c00148163a5d699f">LBL</a>;
<a name="l00370"></a>00370         <a class="code" href="Slib_8h.html#82c26cd350df88414f825bca40183ec2">memcpy</a>((<span class="keywordtype">void</span> *) &amp;fatBuffer[0], (<span class="keywordtype">void</span> *) &amp;VolumesListed[driveNumber].bs, 512);
<a name="l00371"></a>00371         <a class="code" href="Ide_8c.html#a50554702a6b831c05346509d3a8bdc6" title="Grava informações no disco.">writeDisk</a>(driveNumber, &amp;address, fatBuffer);
<a name="l00372"></a>00372 
<a name="l00373"></a>00373         <a class="code" href="Scrn_8h.html#273a809d3de4626e50ad4ecd05c44754" title="Responsável por imprimir mensagens de debug na tela.">APOSDEBUG</a>(<a class="code" href="Fat_8c.html#fb6a77f8fd1dc0be5fb353a7c656387f" title="Variavel que ativa o modo debug, se seu valor for TRUE(1) e desativa se for FALSE(0)...">debugVariable</a>, <span class="stringliteral">"FAT atualizada \n"</span>);
<a name="l00374"></a>00374         <span class="keywordflow">return</span> <a class="code" href="Defs_8h.html#687984f47d8cce148d1b914d2b79612a" title="Successful exit status.">EXIT_SUCCESS</a>;
<a name="l00375"></a>00375 }
<a name="l00376"></a>00376 
<a name="l00383"></a><a class="code" href="KFat_8h.html#6c3231707b55e1e8cc48a1e7923839da">00383</a> <span class="keywordtype">int</span> <a class="code" href="Fat_8c.html#6c3231707b55e1e8cc48a1e7923839da" title="Pegar o valor da LBA*, e calcula o endereço do HD.">calcAddress</a>(<span class="keywordtype">short</span> <span class="keywordtype">int</span> volumeNumber, <span class="keyword">struct</span> <a class="code" href="structdiskAddress.html" title="Estrutura responsável por armazenar o endereço de uma posição do HD.">diskAddress</a> *address) {
<a name="l00384"></a>00384         address-&gt;<a class="code" href="structdiskAddress.html#9e59ac496be4054961ce14949200d79c">sector</a> = address-&gt;<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a> % <a class="code" href="Ide_8c.html#142511891c2876bd8b63491ce80b90bd" title="Retornar a quantidade de setores por trilha de um hd.">getDiskSectorsPerTrack</a>(volumeNumber) + 1;
<a name="l00385"></a>00385         address-&gt;<a class="code" href="structdiskAddress.html#2f7b5031a108153440c4de95187bd274">cylinder</a> = address-&gt;<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a> / (<a class="code" href="Ide_8c.html#a576f9e371be3de5d0abe403b8369ae1" title="Retornar a quantidade de cabeçalhos de um hd.">getDiskHeads</a>(volumeNumber)
<a name="l00386"></a>00386                         * <a class="code" href="Ide_8c.html#142511891c2876bd8b63491ce80b90bd" title="Retornar a quantidade de setores por trilha de um hd.">getDiskSectorsPerTrack</a>(volumeNumber));
<a name="l00387"></a>00387         address-&gt;<a class="code" href="structdiskAddress.html#fec4a33ebc5d3bfdc9a5790532e37a6d">head</a>= (address-&gt;<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a> / <a class="code" href="Ide_8c.html#142511891c2876bd8b63491ce80b90bd" title="Retornar a quantidade de setores por trilha de um hd.">getDiskSectorsPerTrack</a>(volumeNumber))
<a name="l00388"></a>00388                         % <a class="code" href="Ide_8c.html#a576f9e371be3de5d0abe403b8369ae1" title="Retornar a quantidade de cabeçalhos de um hd.">getDiskHeads</a>(volumeNumber);
<a name="l00389"></a>00389         address-&gt;<a class="code" href="structdiskAddress.html#dc9405f2e4d862f336366d5e513a3240">error</a> = <a class="code" href="Defs_8h.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00390"></a>00390         <span class="keywordflow">return</span> <a class="code" href="Defs_8h.html#687984f47d8cce148d1b914d2b79612a" title="Successful exit status.">EXIT_SUCCESS</a>;
<a name="l00391"></a>00391 }
<a name="l00392"></a>00392 
<a name="l00402"></a><a class="code" href="Fat_8h.html#6898244ccdbbe8f9ab35001524802626">00402</a> <span class="keywordtype">int</span> <a class="code" href="Fat_8c.html#6898244ccdbbe8f9ab35001524802626" title="Acrescenta uma entrada de um diretório para outro.">addDirectoryEntry</a>(<span class="keywordtype">short</span> <span class="keywordtype">int</span> driveNumber, <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <span class="keywordtype">int</span> <a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a>,
<a name="l00403"></a>00403                 <span class="keywordtype">char</span> *name, <span class="keyword">struct</span> <a class="code" href="structAttribute.html" title="Representa os atributos que um arquivo ou diretório pode ter.">Attribute</a> attribute, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> fileSize) {
<a name="l00404"></a>00404 
<a name="l00405"></a>00405         <span class="keywordtype">short</span> <span class="keywordtype">int</span> count;
<a name="l00406"></a>00406         <span class="keyword">struct </span><a class="code" href="structfatDirectory.html" title="Estrutura que representa as entradas de um diretório.">fatDirectory</a> *newEntry;
<a name="l00407"></a>00407         <span class="keywordtype">char</span> buffer[512];
<a name="l00408"></a>00408         <span class="keywordtype">short</span> <span class="keywordtype">int</span> position;
<a name="l00409"></a>00409         <span class="keyword">struct </span><a class="code" href="structdiskAddress.html" title="Estrutura responsável por armazenar o endereço de uma posição do HD.">diskAddress</a> address;
<a name="l00410"></a>00410 
<a name="l00411"></a>00411         address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a> = lba;
<a name="l00412"></a>00412         <a class="code" href="Fat_8c.html#6c3231707b55e1e8cc48a1e7923839da" title="Pegar o valor da LBA*, e calcula o endereço do HD.">calcAddress</a>(driveNumber, &amp;address);
<a name="l00413"></a>00413         <a class="code" href="Ide_8c.html#49f300dd0c1649ae2c02f98f021592a6" title="Ler informações no disco.">readDisk</a>(driveNumber, &amp;address, buffer);
<a name="l00414"></a>00414         newEntry = (<span class="keyword">struct </span><a class="code" href="structfatDirectory.html" title="Estrutura que representa as entradas de um diretório.">fatDirectory</a> *) buffer;
<a name="l00415"></a>00415 
<a name="l00416"></a>00416         count = 0;
<a name="l00417"></a>00417         position = 16;
<a name="l00418"></a>00418         <span class="keywordflow">while</span> (position == 16) {
<a name="l00419"></a>00419                 <span class="keywordflow">while</span> (count &lt; 16) {
<a name="l00420"></a>00420                         <span class="comment">//se status não estiver marcado, a posição é selecionada</span>
<a name="l00421"></a>00421                         <span class="keywordflow">if</span> (newEntry[count].attribute.<a class="code" href="structAttribute.html#8a29ec3705c795db68ce2a64aebd2c48">status</a> == <a class="code" href="FatDefs_8h.html#ef5bc51f67c258e3de36353bc58c3dd7">unchecked</a>) {
<a name="l00422"></a>00422                                 position = count;
<a name="l00423"></a>00423                                 count = 16;
<a name="l00424"></a>00424                         }
<a name="l00425"></a>00425                         count++;
<a name="l00426"></a>00426                 }
<a name="l00427"></a>00427                 <span class="comment">//Se passou pelo while acima enão encotrou entrada disponivel, verifica se existe outro </span>
<a name="l00428"></a>00428                 <span class="comment">//entrada para esse diretorio.</span>
<a name="l00429"></a>00429                 <span class="keywordflow">if</span> (position == 16&amp;&amp; VolumesListed[driveNumber].fatList[address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a>]
<a name="l00430"></a>00430                                 != <a class="code" href="FatDefs_8h.html#b6ad368e32c6304728c863dbb1e9d8dd">EOC</a>) {
<a name="l00431"></a>00431                         lba = VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#fd575cf6e0eb42eb1e1bd61617d9494d">fatList</a>[address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a>];
<a name="l00432"></a>00432                         address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a> = lba;
<a name="l00433"></a>00433                         <a class="code" href="Fat_8c.html#6c3231707b55e1e8cc48a1e7923839da" title="Pegar o valor da LBA*, e calcula o endereço do HD.">calcAddress</a>(driveNumber, &amp;address);
<a name="l00434"></a>00434                         <a class="code" href="Ide_8c.html#49f300dd0c1649ae2c02f98f021592a6" title="Ler informações no disco.">readDisk</a>(driveNumber, &amp;address, buffer);
<a name="l00435"></a>00435                         newEntry = (<span class="keyword">struct </span><a class="code" href="structfatDirectory.html" title="Estrutura que representa as entradas de um diretório.">fatDirectory</a> *) buffer;
<a name="l00436"></a>00436                         count = 0;
<a name="l00437"></a>00437                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (position == 16) {
<a name="l00438"></a>00438                         position = 17;
<a name="l00439"></a>00439                 }
<a name="l00440"></a>00440         }
<a name="l00441"></a>00441         <span class="comment">//Caso tenha encontrado espaço sobrando.</span>
<a name="l00442"></a>00442         <span class="keywordflow">if</span> (position != 17) {
<a name="l00443"></a>00443 
<a name="l00444"></a>00444                 <a class="code" href="Fat_8c.html#a607d9c91b3aaa6ad9c6fc0b0f01427d" title="Seta valores para um DirectoryEntry.">setDirectoryEntry</a>(&amp;newEntry[position], name, attribute,
<a name="l00445"></a>00445                                 VolumesListed[driveNumber].LBL, fileSize);
<a name="l00446"></a>00446 
<a name="l00447"></a>00447                 <a class="code" href="Slib_8h.html#82c26cd350df88414f825bca40183ec2">memcpy</a>(buffer, newEntry, 512);
<a name="l00448"></a>00448                 <a class="code" href="Ide_8c.html#a50554702a6b831c05346509d3a8bdc6" title="Grava informações no disco.">writeDisk</a>(driveNumber, &amp;address, buffer);
<a name="l00449"></a>00449                 <span class="comment">//caso não encontre espaço disponivel.</span>
<a name="l00450"></a>00450         } <span class="keywordflow">else</span> {
<a name="l00451"></a>00451                 <span class="keyword">struct </span><a class="code" href="structfatDirectory.html" title="Estrutura que representa as entradas de um diretório.">fatDirectory</a> new[16];
<a name="l00452"></a>00452 
<a name="l00453"></a>00453                 address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a> = VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#12b2937b5c7692c9c00148163a5d699f">LBL</a>;
<a name="l00454"></a>00454                 VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#12b2937b5c7692c9c00148163a5d699f">LBL</a>
<a name="l00455"></a>00455                                 = VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#fd575cf6e0eb42eb1e1bd61617d9494d">fatList</a>[VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#12b2937b5c7692c9c00148163a5d699f">LBL</a>];
<a name="l00456"></a>00456                 VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#fd575cf6e0eb42eb1e1bd61617d9494d">fatList</a>[lba] = address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a>;
<a name="l00457"></a>00457                 VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#fd575cf6e0eb42eb1e1bd61617d9494d">fatList</a>[address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a>] = <a class="code" href="FatDefs_8h.html#b6ad368e32c6304728c863dbb1e9d8dd">EOC</a>;
<a name="l00458"></a>00458 
<a name="l00459"></a>00459                 <span class="keywordflow">for</span> (count = 1; count &lt; 16; count++) {
<a name="l00460"></a>00460                         <span class="keyword">new</span>[count].startCluster = 0;
<a name="l00461"></a>00461                         <span class="keyword">new</span>[count].attribute.status = 0;
<a name="l00462"></a>00462                 }
<a name="l00463"></a>00463 
<a name="l00464"></a>00464                 <a class="code" href="Fat_8c.html#a607d9c91b3aaa6ad9c6fc0b0f01427d" title="Seta valores para um DirectoryEntry.">setDirectoryEntry</a>(&amp;<span class="keyword">new</span>[0], name , attribute ,
<a name="l00465"></a>00465                                 VolumesListed[driveNumber].LBL, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> )fileSize );
<a name="l00466"></a>00466                 <a class="code" href="Slib_8h.html#82c26cd350df88414f825bca40183ec2">memcpy</a>(buffer, <span class="keyword">new</span>, 512);
<a name="l00467"></a>00467                 <a class="code" href="Fat_8c.html#6c3231707b55e1e8cc48a1e7923839da" title="Pegar o valor da LBA*, e calcula o endereço do HD.">calcAddress</a>(driveNumber, &amp;address);
<a name="l00468"></a>00468                 <a class="code" href="Ide_8c.html#a50554702a6b831c05346509d3a8bdc6" title="Grava informações no disco.">writeDisk</a>(driveNumber, &amp;address, buffer);
<a name="l00469"></a>00469 
<a name="l00470"></a>00470                 <a class="code" href="Fat_8c.html#b2ef313f23df0aeadc3741f16bdcb75f" title="Grava as ultimas modificações da FAT no HD.">updateFat</a>(driveNumber);
<a name="l00471"></a>00471         }
<a name="l00472"></a>00472         <span class="keywordflow">return</span> <a class="code" href="Defs_8h.html#687984f47d8cce148d1b914d2b79612a" title="Successful exit status.">EXIT_SUCCESS</a>;
<a name="l00473"></a>00473 }
<a name="l00474"></a>00474 
<a name="l00484"></a><a class="code" href="Fat_8h.html#a607d9c91b3aaa6ad9c6fc0b0f01427d">00484</a> <span class="keywordtype">int</span> <a class="code" href="Fat_8c.html#a607d9c91b3aaa6ad9c6fc0b0f01427d" title="Seta valores para um DirectoryEntry.">setDirectoryEntry</a>(<span class="keyword">struct</span> <a class="code" href="structfatDirectory.html" title="Estrutura que representa as entradas de um diretório.">fatDirectory</a> *newEntry, <span class="keywordtype">char</span> *name,
<a name="l00485"></a>00485                 <span class="keyword">struct</span> <a class="code" href="structAttribute.html" title="Representa os atributos que um arquivo ou diretório pode ter.">Attribute</a> <a class="code" href="structfatDirectory.html#16fb47757a9786affc18f93576abdb58">attribute</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <span class="keywordtype">int</span> <a class="code" href="structfatDirectory.html#c0cc3c681cc7daddcd54257becc6b2dd">startCluster</a>,
<a name="l00486"></a>00486                 <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> <a class="code" href="structfatDirectory.html#4bea39f8d6c526ccab754274c10ea0d5">fileSize</a>) {
<a name="l00487"></a>00487         <span class="keywordtype">short</span> <span class="keywordtype">int</span> count;
<a name="l00488"></a>00488 
<a name="l00489"></a>00489         newEntry-&gt;<a class="code" href="structfatDirectory.html#16fb47757a9786affc18f93576abdb58">attribute</a>.<a class="code" href="structAttribute.html#352bfa638e4fe8f173f36479e6afb284">directory</a> = attribute.<a class="code" href="structAttribute.html#352bfa638e4fe8f173f36479e6afb284">directory</a>;
<a name="l00490"></a>00490         newEntry-&gt;<a class="code" href="structfatDirectory.html#16fb47757a9786affc18f93576abdb58">attribute</a>.<a class="code" href="structAttribute.html#1e9b5af14a50071b88f2c45ca12e6fc0">file</a> = attribute.<a class="code" href="structAttribute.html#1e9b5af14a50071b88f2c45ca12e6fc0">file</a>;
<a name="l00491"></a>00491         newEntry-&gt;<a class="code" href="structfatDirectory.html#16fb47757a9786affc18f93576abdb58">attribute</a>.<a class="code" href="structAttribute.html#2dad6a62417448e1c60f4c32992975e8">hidden</a> = attribute.<a class="code" href="structAttribute.html#2dad6a62417448e1c60f4c32992975e8">hidden</a>;
<a name="l00492"></a>00492         newEntry-&gt;<a class="code" href="structfatDirectory.html#16fb47757a9786affc18f93576abdb58">attribute</a>.<a class="code" href="structAttribute.html#4d96cf5f87e43b02038d890c0d795666">readOnly</a> = attribute.<a class="code" href="structAttribute.html#4d96cf5f87e43b02038d890c0d795666">readOnly</a>;
<a name="l00493"></a>00493         newEntry-&gt;<a class="code" href="structfatDirectory.html#16fb47757a9786affc18f93576abdb58">attribute</a>.<a class="code" href="structAttribute.html#8a29ec3705c795db68ce2a64aebd2c48">status</a> = <a class="code" href="FatDefs_8h.html#e17eeb06f496b8ec152d32a5aa746482">checked</a>;
<a name="l00494"></a>00494 
<a name="l00495"></a>00495         count = 0;
<a name="l00496"></a>00496 
<a name="l00497"></a>00497         <span class="keywordflow">while</span> (name[count] != <span class="charliteral">'.'</span>&amp;&amp; count &lt; 8) {
<a name="l00498"></a>00498                 newEntry-&gt;<a class="code" href="structfatDirectory.html#34150d64347f0bafe36f0781e17a2f16">file</a>.<a class="code" href="structName.html#8739c71aa4a6b401b61bd741ef390194">name</a>[count] = name[count];
<a name="l00499"></a>00499                 count++;
<a name="l00500"></a>00500         }
<a name="l00501"></a>00501 
<a name="l00502"></a>00502         <span class="keywordflow">if</span> (name[count] == <span class="charliteral">'.'</span>) {
<a name="l00503"></a>00503                 newEntry-&gt;<a class="code" href="structfatDirectory.html#34150d64347f0bafe36f0781e17a2f16">file</a>.<a class="code" href="structName.html#8739c71aa4a6b401b61bd741ef390194">name</a>[count]=<span class="charliteral">'\0'</span>;
<a name="l00504"></a>00504         }
<a name="l00505"></a>00505 
<a name="l00506"></a>00506         <span class="keywordflow">if</span> (newEntry-&gt;<a class="code" href="structfatDirectory.html#16fb47757a9786affc18f93576abdb58">attribute</a>.<a class="code" href="structAttribute.html#1e9b5af14a50071b88f2c45ca12e6fc0">file</a> == <a class="code" href="FatDefs_8h.html#e17eeb06f496b8ec152d32a5aa746482">checked</a>) {
<a name="l00507"></a>00507                 <a class="code" href="Slib_8h.html#82c26cd350df88414f825bca40183ec2">memcpy</a>(newEntry-&gt;<a class="code" href="structfatDirectory.html#34150d64347f0bafe36f0781e17a2f16">file</a>.<a class="code" href="structName.html#4fbb7c79c3d895d551e797daed3fe30d">type</a>, &amp;name[count + 1], 3);
<a name="l00508"></a>00508         }
<a name="l00509"></a>00509 
<a name="l00510"></a>00510         newEntry-&gt;<a class="code" href="structfatDirectory.html#c0cc3c681cc7daddcd54257becc6b2dd">startCluster</a> = startCluster;
<a name="l00511"></a>00511         newEntry-&gt;<a class="code" href="structfatDirectory.html#4bea39f8d6c526ccab754274c10ea0d5">fileSize</a> = fileSize;
<a name="l00512"></a>00512         <span class="keywordflow">return</span> <a class="code" href="Defs_8h.html#687984f47d8cce148d1b914d2b79612a" title="Successful exit status.">EXIT_SUCCESS</a>;
<a name="l00513"></a>00513 }
<a name="l00514"></a>00514 
<a name="l00522"></a><a class="code" href="KFat_8h.html#1be2e5bac21b53aa3d6736bc4beb628b">00522</a> <span class="keywordtype">int</span> <a class="code" href="Fat_8c.html#1be2e5bac21b53aa3d6736bc4beb628b" title="Ler um arquivo do diretório atual.">readFile</a>(<span class="keywordtype">short</span> <span class="keywordtype">int</span> driveNumber, <span class="keywordtype">char</span> *name, <span class="keywordtype">char</span> *type) {
<a name="l00523"></a>00523         <span class="keywordtype">short</span> <span class="keywordtype">int</span> count;
<a name="l00524"></a>00524         <span class="keyword">struct </span><a class="code" href="structfatDirectory.html" title="Estrutura que representa as entradas de um diretório.">fatDirectory</a> *entry;
<a name="l00525"></a>00525         <span class="keywordtype">char</span> buffer[512];
<a name="l00526"></a>00526         <span class="keywordtype">short</span> <span class="keywordtype">int</span> position;
<a name="l00527"></a>00527         <span class="keyword">struct </span><a class="code" href="structdiskAddress.html" title="Estrutura responsável por armazenar o endereço de uma posição do HD.">diskAddress</a> address;
<a name="l00528"></a>00528         <span class="keywordtype">char</span> typeBuffer[4];
<a name="l00529"></a>00529         <span class="keywordtype">char</span> nameBuffer[9];
<a name="l00530"></a>00530         <span class="keywordtype">int</span> letter;
<a name="l00531"></a>00531 
<a name="l00532"></a>00532         address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a> = VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#eda5a7c1a9a78740fcd1029544c08a3d">actualDirectory</a>.<a class="code" href="structfatDirectory.html#c0cc3c681cc7daddcd54257becc6b2dd">startCluster</a>;
<a name="l00533"></a>00533         <a class="code" href="Fat_8c.html#6c3231707b55e1e8cc48a1e7923839da" title="Pegar o valor da LBA*, e calcula o endereço do HD.">calcAddress</a>(driveNumber, &amp;address);
<a name="l00534"></a>00534         <a class="code" href="Ide_8c.html#49f300dd0c1649ae2c02f98f021592a6" title="Ler informações no disco.">readDisk</a>(driveNumber, &amp;address, buffer);
<a name="l00535"></a>00535         entry = (<span class="keyword">struct </span><a class="code" href="structfatDirectory.html" title="Estrutura que representa as entradas de um diretório.">fatDirectory</a> *) buffer;
<a name="l00536"></a>00536         count = 0;
<a name="l00537"></a>00537 
<a name="l00538"></a>00538         position = 16;
<a name="l00539"></a>00539         <span class="comment">//O while mais interno serve para verificar se a entrada de diretório esta no cluster atual,</span>
<a name="l00540"></a>00540         <span class="comment">//e o while mais externo serve para verificar que aquele diretório não ocupa mais de um cluster.</span>
<a name="l00541"></a>00541         <span class="comment">//Cada cluster consegue ter até 16 itens gravados nele.</span>
<a name="l00542"></a>00542         <span class="keywordflow">while</span> (position == 16) {
<a name="l00543"></a>00543                 <span class="keywordflow">while</span> (count &lt; 16) {
<a name="l00544"></a>00544                         typeBuffer[0] = entry[count].<a class="code" href="structfatDirectory.html#34150d64347f0bafe36f0781e17a2f16">file</a>.<a class="code" href="structName.html#4fbb7c79c3d895d551e797daed3fe30d">type</a>[0];
<a name="l00545"></a>00545                         typeBuffer[1] = entry[count].<a class="code" href="structfatDirectory.html#34150d64347f0bafe36f0781e17a2f16">file</a>.<a class="code" href="structName.html#4fbb7c79c3d895d551e797daed3fe30d">type</a>[1];
<a name="l00546"></a>00546                         typeBuffer[2] = entry[count].<a class="code" href="structfatDirectory.html#34150d64347f0bafe36f0781e17a2f16">file</a>.<a class="code" href="structName.html#4fbb7c79c3d895d551e797daed3fe30d">type</a>[2];
<a name="l00547"></a>00547                         typeBuffer[3] = <span class="charliteral">'\0'</span>;
<a name="l00548"></a>00548                         letter = 0;
<a name="l00549"></a>00549 
<a name="l00550"></a>00550                         <span class="keywordflow">while</span> (letter &lt; 8&amp;&amp; entry[count].<a class="code" href="structfatDirectory.html#34150d64347f0bafe36f0781e17a2f16">file</a>.<a class="code" href="structName.html#8739c71aa4a6b401b61bd741ef390194">name</a>[letter] != <span class="charliteral">'\0'</span>) {
<a name="l00551"></a>00551                                 nameBuffer[letter] = entry[count].<a class="code" href="structfatDirectory.html#34150d64347f0bafe36f0781e17a2f16">file</a>.<a class="code" href="structName.html#8739c71aa4a6b401b61bd741ef390194">name</a>[letter];
<a name="l00552"></a>00552                                 letter++;
<a name="l00553"></a>00553                         }
<a name="l00554"></a>00554 
<a name="l00555"></a>00555                         nameBuffer[letter] = <span class="charliteral">'\0'</span>;
<a name="l00556"></a>00556 
<a name="l00557"></a>00557                         <span class="keywordflow">if</span> ((<a class="code" href="Slib_8h.html#15bde2174f2412867fc36278b65af29c">strcmp</a>(name, nameBuffer))&amp;&amp; (<a class="code" href="Slib_8h.html#15bde2174f2412867fc36278b65af29c">strcmp</a>(type, typeBuffer))) {
<a name="l00558"></a>00558                                 position = count;
<a name="l00559"></a>00559                                 count = 16;
<a name="l00560"></a>00560                         }
<a name="l00561"></a>00561                         count++;
<a name="l00562"></a>00562                 }
<a name="l00563"></a>00563                 <span class="comment">/*</span>
<a name="l00564"></a>00564 <span class="comment">                 * </span>
<a name="l00565"></a>00565 <span class="comment">                 * Caso não encontre o arquivo a deletar, ele procura por outro cluster do diretório,</span>
<a name="l00566"></a>00566 <span class="comment">                 * até ter checado todos as entradas preenchidas no diretório.</span>
<a name="l00567"></a>00567 <span class="comment">                 */</span>
<a name="l00568"></a>00568                 <span class="keywordflow">if</span> (position == 16&amp;&amp; VolumesListed[driveNumber].fatList[address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a>]
<a name="l00569"></a>00569                                 != <a class="code" href="FatDefs_8h.html#b6ad368e32c6304728c863dbb1e9d8dd">EOC</a>) {
<a name="l00570"></a>00570                         address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a> = VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#fd575cf6e0eb42eb1e1bd61617d9494d">fatList</a>[address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a>];
<a name="l00571"></a>00571                         <a class="code" href="Fat_8c.html#6c3231707b55e1e8cc48a1e7923839da" title="Pegar o valor da LBA*, e calcula o endereço do HD.">calcAddress</a>(driveNumber, &amp;address);
<a name="l00572"></a>00572                         <a class="code" href="Ide_8c.html#49f300dd0c1649ae2c02f98f021592a6" title="Ler informações no disco.">readDisk</a>(driveNumber, &amp;address, buffer);
<a name="l00573"></a>00573                         entry = (<span class="keyword">struct </span><a class="code" href="structfatDirectory.html" title="Estrutura que representa as entradas de um diretório.">fatDirectory</a> *) buffer;
<a name="l00574"></a>00574                         count = 0;
<a name="l00575"></a>00575                         <span class="comment">/* caso não encontre o arquivo e já tenha lido todos os cluster do diretório,</span>
<a name="l00576"></a>00576 <span class="comment">                         * ele sai, sem modificar nada.</span>
<a name="l00577"></a>00577 <span class="comment">                         */</span>
<a name="l00578"></a>00578                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (position == 16) {
<a name="l00579"></a>00579                         position = 17;
<a name="l00580"></a>00580                 }
<a name="l00581"></a>00581         }
<a name="l00582"></a>00582 
<a name="l00583"></a>00583         <span class="keywordflow">if</span> (position != 16) {
<a name="l00584"></a>00584 
<a name="l00585"></a>00585                 address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a> = entry[position].<a class="code" href="structfatDirectory.html#c0cc3c681cc7daddcd54257becc6b2dd">startCluster</a>;
<a name="l00586"></a>00586                 <a class="code" href="Fat_8c.html#6c3231707b55e1e8cc48a1e7923839da" title="Pegar o valor da LBA*, e calcula o endereço do HD.">calcAddress</a>(driveNumber, &amp;address);
<a name="l00587"></a>00587                 <a class="code" href="Ide_8c.html#49f300dd0c1649ae2c02f98f021592a6" title="Ler informações no disco.">readDisk</a>(driveNumber, &amp;address, buffer);
<a name="l00588"></a>00588                 <a class="code" href="Scrn_8h.html#ffb7f407d6601f057a9c641482a344a0" title="Usa uma rotina para imprimi uma STRING.">puts</a>(buffer);
<a name="l00589"></a>00589         } <span class="keywordflow">else</span> {
<a name="l00590"></a>00590                 <a class="code" href="Scrn_8h.html#ffb7f407d6601f057a9c641482a344a0" title="Usa uma rotina para imprimi uma STRING.">puts</a>(<span class="stringliteral">"arquivo nao encontrado...."</span>);
<a name="l00591"></a>00591         }
<a name="l00592"></a>00592 
<a name="l00593"></a>00593         <span class="keywordflow">return</span> <a class="code" href="Defs_8h.html#687984f47d8cce148d1b914d2b79612a" title="Successful exit status.">EXIT_SUCCESS</a>;
<a name="l00594"></a>00594 }
<a name="l00603"></a><a class="code" href="KFat_8h.html#95a7aeafd74b4f8fc670ad5289a12395">00603</a> <span class="keywordtype">int</span> <a class="code" href="Fat_8c.html#95a7aeafd74b4f8fc670ad5289a12395" title="Cria uma arquivo no diretório atual.">createFile</a>(<span class="keywordtype">short</span> <span class="keywordtype">int</span> driveNumber, <span class="keywordtype">char</span> *name, <span class="keywordtype">char</span> attr, <span class="keywordtype">char</span> *<a class="code" href="structfatDirectory.html#34150d64347f0bafe36f0781e17a2f16">file</a>) {
<a name="l00604"></a>00604         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structfatDirectory.html#4bea39f8d6c526ccab754274c10ea0d5">fileSize</a>;
<a name="l00605"></a>00605         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <span class="keywordtype">int</span> dirPos;
<a name="l00606"></a>00606         <span class="keyword">struct </span><a class="code" href="structAttribute.html" title="Representa os atributos que um arquivo ou diretório pode ter.">Attribute</a> attribute;
<a name="l00607"></a>00607         <span class="keyword">struct </span><a class="code" href="structdiskAddress.html" title="Estrutura responsável por armazenar o endereço de uma posição do HD.">diskAddress</a> address;
<a name="l00608"></a>00608         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <span class="keywordtype">int</span> cluster, count;
<a name="l00609"></a>00609 
<a name="l00610"></a>00610         attribute.<a class="code" href="structAttribute.html#1e9b5af14a50071b88f2c45ca12e6fc0">file</a> = <a class="code" href="FatDefs_8h.html#e17eeb06f496b8ec152d32a5aa746482">checked</a>;
<a name="l00611"></a>00611         attribute.<a class="code" href="structAttribute.html#352bfa638e4fe8f173f36479e6afb284">directory</a> = <a class="code" href="FatDefs_8h.html#ef5bc51f67c258e3de36353bc58c3dd7">unchecked</a>;
<a name="l00612"></a>00612         attribute.<a class="code" href="structAttribute.html#8a29ec3705c795db68ce2a64aebd2c48">status</a> = <a class="code" href="FatDefs_8h.html#e17eeb06f496b8ec152d32a5aa746482">checked</a>;
<a name="l00613"></a>00613 
<a name="l00614"></a>00614         <span class="keywordflow">if</span> (attr == 1) {
<a name="l00615"></a>00615                 attribute.<a class="code" href="structAttribute.html#4d96cf5f87e43b02038d890c0d795666">readOnly</a> = <a class="code" href="FatDefs_8h.html#e17eeb06f496b8ec152d32a5aa746482">checked</a>;
<a name="l00616"></a>00616         }
<a name="l00617"></a>00617 
<a name="l00618"></a>00618         <span class="comment">//pegar o número do cluster inicial, onde o arquivo será gravado,</span>
<a name="l00619"></a>00619         <span class="comment">// para adicionar a ele mais um item.</span>
<a name="l00620"></a>00620         dirPos = VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#eda5a7c1a9a78740fcd1029544c08a3d">actualDirectory</a>.<a class="code" href="structfatDirectory.html#c0cc3c681cc7daddcd54257becc6b2dd">startCluster</a>;
<a name="l00621"></a>00621         fileSize = <a class="code" href="Slib_8h.html#c6b5c6676a3d76674a299a4c92e54e27">strlenght</a>(file);
<a name="l00622"></a>00622         <a class="code" href="Fat_8c.html#6898244ccdbbe8f9ab35001524802626" title="Acrescenta uma entrada de um diretório para outro.">addDirectoryEntry</a>(driveNumber, dirPos, name, attribute, fileSize);
<a name="l00623"></a>00623 
<a name="l00624"></a>00624         cluster = fileSize / VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#14605661c88f332ddd66ec510fe1d90c">bs</a>.<a class="code" href="structtBpb.html#9cd180897deee245ef75b0cdd692c408">BPB_BytsPerSec</a>;
<a name="l00625"></a>00625         <span class="keywordflow">if</span> (fileSize % 512) {
<a name="l00626"></a>00626                 cluster= cluster + 1;
<a name="l00627"></a>00627         }
<a name="l00628"></a>00628         count = 0;
<a name="l00629"></a>00629         <span class="keywordflow">for</span> (; cluster != 0; cluster--) {
<a name="l00630"></a>00630                 address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a> = VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#12b2937b5c7692c9c00148163a5d699f">LBL</a>;
<a name="l00631"></a>00631                 VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#12b2937b5c7692c9c00148163a5d699f">LBL</a>
<a name="l00632"></a>00632                                 = VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#fd575cf6e0eb42eb1e1bd61617d9494d">fatList</a>[VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#12b2937b5c7692c9c00148163a5d699f">LBL</a>];
<a name="l00633"></a>00633                 <a class="code" href="Fat_8c.html#6c3231707b55e1e8cc48a1e7923839da" title="Pegar o valor da LBA*, e calcula o endereço do HD.">calcAddress</a>(driveNumber, &amp;address);
<a name="l00634"></a>00634                 <a class="code" href="Ide_8c.html#a50554702a6b831c05346509d3a8bdc6" title="Grava informações no disco.">writeDisk</a>(driveNumber, &amp;address, &amp;file[count]);
<a name="l00635"></a>00635                 count = count + VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#14605661c88f332ddd66ec510fe1d90c">bs</a>.<a class="code" href="structtBpb.html#9cd180897deee245ef75b0cdd692c408">BPB_BytsPerSec</a>;
<a name="l00636"></a>00636         }
<a name="l00637"></a>00637         VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#fd575cf6e0eb42eb1e1bd61617d9494d">fatList</a>[address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a>] = <a class="code" href="FatDefs_8h.html#b6ad368e32c6304728c863dbb1e9d8dd">EOC</a>;
<a name="l00638"></a>00638 
<a name="l00639"></a>00639         <a class="code" href="Fat_8c.html#b2ef313f23df0aeadc3741f16bdcb75f" title="Grava as ultimas modificações da FAT no HD.">updateFat</a>(driveNumber);
<a name="l00640"></a>00640         <span class="keywordflow">return</span> <a class="code" href="Defs_8h.html#687984f47d8cce148d1b914d2b79612a" title="Successful exit status.">EXIT_SUCCESS</a>;
<a name="l00641"></a>00641 }
<a name="l00651"></a><a class="code" href="KFat_8h.html#fdc91eb61dc27e41e7a89455c9909316">00651</a> <span class="keywordtype">int</span> <a class="code" href="Fat_8c.html#fdc91eb61dc27e41e7a89455c9909316" title="Deleta um arquivo do diretório atual.">delFile</a>(<span class="keywordtype">short</span> <span class="keywordtype">int</span> driveNumber, <span class="keywordtype">char</span> *name, <span class="keywordtype">char</span> *type,
<a name="l00652"></a>00652                 <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <span class="keywordtype">int</span> dirStartCluster) {
<a name="l00653"></a>00653         <span class="keywordtype">short</span> <span class="keywordtype">int</span> count;
<a name="l00654"></a>00654         <span class="keyword">struct </span><a class="code" href="structfatDirectory.html" title="Estrutura que representa as entradas de um diretório.">fatDirectory</a> *entry;
<a name="l00655"></a>00655         <span class="keywordtype">char</span> buffer[512];
<a name="l00656"></a>00656         <span class="keywordtype">short</span> <span class="keywordtype">int</span> position;
<a name="l00657"></a>00657         <span class="keyword">struct </span><a class="code" href="structdiskAddress.html" title="Estrutura responsável por armazenar o endereço de uma posição do HD.">diskAddress</a> address;
<a name="l00658"></a>00658         <span class="keywordtype">char</span> typeBuffer1[4];
<a name="l00659"></a>00659         <span class="keywordtype">char</span> typeBuffer2[4];
<a name="l00660"></a>00660 
<a name="l00661"></a>00661         <span class="comment">//caso não seja informado nenhum diretório para remoção do arquivo o sistema levaram em consideração que ele esta na no diretório atual.</span>
<a name="l00662"></a>00662         <span class="keywordflow">if</span> (dirStartCluster == 0) {
<a name="l00663"></a>00663                 address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a> = VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#eda5a7c1a9a78740fcd1029544c08a3d">actualDirectory</a>.<a class="code" href="structfatDirectory.html#c0cc3c681cc7daddcd54257becc6b2dd">startCluster</a>;
<a name="l00664"></a>00664         } <span class="keywordflow">else</span> {
<a name="l00665"></a>00665                 address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a> = dirStartCluster;
<a name="l00666"></a>00666         }
<a name="l00667"></a>00667         <a class="code" href="Fat_8c.html#6c3231707b55e1e8cc48a1e7923839da" title="Pegar o valor da LBA*, e calcula o endereço do HD.">calcAddress</a>(driveNumber, &amp;address);
<a name="l00668"></a>00668         <a class="code" href="Ide_8c.html#49f300dd0c1649ae2c02f98f021592a6" title="Ler informações no disco.">readDisk</a>(driveNumber, &amp;address, buffer);
<a name="l00669"></a>00669         entry = (<span class="keyword">struct </span><a class="code" href="structfatDirectory.html" title="Estrutura que representa as entradas de um diretório.">fatDirectory</a> *) buffer;
<a name="l00670"></a>00670         count = 0;
<a name="l00671"></a>00671 
<a name="l00672"></a>00672         position = 16;
<a name="l00673"></a>00673         <span class="keywordflow">while</span> (position == 16) {
<a name="l00674"></a>00674                 <span class="keywordflow">while</span> (count &lt; 16) {
<a name="l00675"></a>00675                         <a class="code" href="Slib_8h.html#82c26cd350df88414f825bca40183ec2">memcpy</a>(typeBuffer1, entry[count].<a class="code" href="structfatDirectory.html#34150d64347f0bafe36f0781e17a2f16">file</a>.<a class="code" href="structName.html#4fbb7c79c3d895d551e797daed3fe30d">type</a>, 3);
<a name="l00676"></a>00676                         typeBuffer1[3] = <span class="charliteral">'\0'</span>;
<a name="l00677"></a>00677                         <a class="code" href="Slib_8h.html#82c26cd350df88414f825bca40183ec2">memcpy</a>(typeBuffer2, type, 3);
<a name="l00678"></a>00678                         typeBuffer2[3] = <span class="charliteral">'\0'</span>;
<a name="l00679"></a>00679                         <span class="keywordflow">if</span> ((<a class="code" href="Slib_8h.html#15bde2174f2412867fc36278b65af29c">strcmp</a>(name, entry[count].<a class="code" href="structfatDirectory.html#34150d64347f0bafe36f0781e17a2f16">file</a>.<a class="code" href="structName.html#8739c71aa4a6b401b61bd741ef390194">name</a>)) &amp;&amp; (<a class="code" href="Slib_8h.html#15bde2174f2412867fc36278b65af29c">strcmp</a>(typeBuffer2,
<a name="l00680"></a>00680                                         typeBuffer1))) {
<a name="l00681"></a>00681                                 position = count;
<a name="l00682"></a>00682                                 count = 15;
<a name="l00683"></a>00683                         }
<a name="l00684"></a>00684                         count++;
<a name="l00685"></a>00685                 }
<a name="l00686"></a>00686                 <span class="comment">/*</span>
<a name="l00687"></a>00687 <span class="comment">                 * Caso não encontre o arquivo a deletar, ele procura por outro cluster do diretório,</span>
<a name="l00688"></a>00688 <span class="comment">                 * até ter checado todas as entradas do diretório.</span>
<a name="l00689"></a>00689 <span class="comment">                 */</span>
<a name="l00690"></a>00690                 <span class="keywordflow">if</span> (position == 16 &amp;&amp; VolumesListed[driveNumber].fatList[address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a>] != <a class="code" href="FatDefs_8h.html#b6ad368e32c6304728c863dbb1e9d8dd">EOC</a>) {
<a name="l00691"></a>00691                         address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a> = VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#fd575cf6e0eb42eb1e1bd61617d9494d">fatList</a>[address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a>];
<a name="l00692"></a>00692                         <a class="code" href="Fat_8c.html#6c3231707b55e1e8cc48a1e7923839da" title="Pegar o valor da LBA*, e calcula o endereço do HD.">calcAddress</a>(driveNumber, &amp;address);
<a name="l00693"></a>00693                         <a class="code" href="Ide_8c.html#49f300dd0c1649ae2c02f98f021592a6" title="Ler informações no disco.">readDisk</a>(driveNumber, &amp;address, buffer);
<a name="l00694"></a>00694                         entry = (<span class="keyword">struct </span><a class="code" href="structfatDirectory.html" title="Estrutura que representa as entradas de um diretório.">fatDirectory</a> *) buffer;
<a name="l00695"></a>00695                         count = 0;
<a name="l00696"></a>00696                         <span class="comment">/* </span>
<a name="l00697"></a>00697 <span class="comment">                         * caso não encontre o arquivo e já tenha lido todos os cluster do diretório,</span>
<a name="l00698"></a>00698 <span class="comment">                         * ele sai, sem modificar nada.</span>
<a name="l00699"></a>00699 <span class="comment">                         */</span>
<a name="l00700"></a>00700                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (position == 16) {
<a name="l00701"></a>00701                         position = 17;
<a name="l00702"></a>00702                 }
<a name="l00703"></a>00703         }
<a name="l00704"></a>00704         <span class="comment">/*</span>
<a name="l00705"></a>00705 <span class="comment">         * quando encontra o arquivo a ser apagado ele marca como unchecked.</span>
<a name="l00706"></a>00706 <span class="comment">         */</span>
<a name="l00707"></a>00707         <span class="keywordflow">if</span> (position != 17) {
<a name="l00708"></a>00708 
<a name="l00709"></a>00709                 entry[position].<a class="code" href="structfatDirectory.html#16fb47757a9786affc18f93576abdb58">attribute</a>.<a class="code" href="structAttribute.html#8a29ec3705c795db68ce2a64aebd2c48">status</a> = <a class="code" href="FatDefs_8h.html#ef5bc51f67c258e3de36353bc58c3dd7">unchecked</a>;
<a name="l00710"></a>00710 
<a name="l00711"></a>00711                 count = entry[position].<a class="code" href="structfatDirectory.html#c0cc3c681cc7daddcd54257becc6b2dd">startCluster</a>;
<a name="l00712"></a>00712 
<a name="l00713"></a>00713                 <a class="code" href="Slib_8h.html#82c26cd350df88414f825bca40183ec2">memcpy</a>(buffer, entry, 512);
<a name="l00714"></a>00714                 <a class="code" href="Ide_8c.html#a50554702a6b831c05346509d3a8bdc6" title="Grava informações no disco.">writeDisk</a>(driveNumber, &amp;address, buffer);
<a name="l00715"></a>00715                 position = count;
<a name="l00716"></a>00716                 <span class="keywordflow">while</span> (VolumesListed[driveNumber].fatList[count] != <a class="code" href="FatDefs_8h.html#b6ad368e32c6304728c863dbb1e9d8dd">EOC</a>) {
<a name="l00717"></a>00717                         count = VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#fd575cf6e0eb42eb1e1bd61617d9494d">fatList</a>[count];
<a name="l00718"></a>00718                 }
<a name="l00719"></a>00719                 VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#fd575cf6e0eb42eb1e1bd61617d9494d">fatList</a>[count]
<a name="l00720"></a>00720                                 = VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#12b2937b5c7692c9c00148163a5d699f">LBL</a>;
<a name="l00721"></a>00721                 VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#12b2937b5c7692c9c00148163a5d699f">LBL</a> = position;
<a name="l00722"></a>00722                 <a class="code" href="Fat_8c.html#b2ef313f23df0aeadc3741f16bdcb75f" title="Grava as ultimas modificações da FAT no HD.">updateFat</a>(driveNumber);
<a name="l00723"></a>00723 
<a name="l00724"></a>00724                 <span class="comment">/*</span>
<a name="l00725"></a>00725 <span class="comment">                 * Se não encontrar imprimi umas mensagem na tela avisando.</span>
<a name="l00726"></a>00726 <span class="comment">                 */</span>
<a name="l00727"></a>00727         } <span class="keywordflow">else</span> {
<a name="l00728"></a>00728                 <a class="code" href="Scrn_8h.html#ffb7f407d6601f057a9c641482a344a0" title="Usa uma rotina para imprimi uma STRING.">puts</a>(<span class="stringliteral">"arquivo para remocao nao encontrado"</span>);
<a name="l00729"></a>00729         }
<a name="l00730"></a>00730         <span class="keywordflow">return</span> <a class="code" href="Defs_8h.html#687984f47d8cce148d1b914d2b79612a" title="Successful exit status.">EXIT_SUCCESS</a>;
<a name="l00731"></a>00731 }
<a name="l00732"></a>00732 
<a name="l00740"></a><a class="code" href="KFat_8h.html#3db07212e5795833bdd0c6a4bfd29986">00740</a> <span class="keywordtype">int</span> <a class="code" href="Fat_8c.html#3db07212e5795833bdd0c6a4bfd29986" title="Cria um diretorio.">createDIR</a>(<span class="keywordtype">short</span> <span class="keywordtype">int</span> driveNumber, <span class="keywordtype">char</span> *name, <span class="keywordtype">char</span> attr) {
<a name="l00741"></a>00741         <span class="keywordtype">char</span> buffer[512];
<a name="l00742"></a>00742         <span class="keywordtype">short</span> <span class="keywordtype">int</span> count;
<a name="l00743"></a>00743         <span class="keywordtype">short</span> <span class="keywordtype">int</span> <a class="code" href="structfatDirectory.html#c0cc3c681cc7daddcd54257becc6b2dd">startCluster</a>;
<a name="l00744"></a>00744         <span class="keywordtype">short</span> <span class="keywordtype">int</span> <a class="code" href="structfatDirectory.html#4bea39f8d6c526ccab754274c10ea0d5">fileSize</a>;
<a name="l00745"></a>00745         <span class="keyword">struct </span><a class="code" href="structdiskAddress.html" title="Estrutura responsável por armazenar o endereço de uma posição do HD.">diskAddress</a> address;
<a name="l00746"></a>00746         <span class="keyword">struct </span><a class="code" href="structfatDirectory.html" title="Estrutura que representa as entradas de um diretório.">fatDirectory</a> new[16];
<a name="l00747"></a>00747         <span class="keyword">struct </span><a class="code" href="structAttribute.html" title="Representa os atributos que um arquivo ou diretório pode ter.">Attribute</a> attribute;
<a name="l00748"></a>00748 
<a name="l00749"></a>00749         attribute.<a class="code" href="structAttribute.html#352bfa638e4fe8f173f36479e6afb284">directory</a> = <a class="code" href="FatDefs_8h.html#e17eeb06f496b8ec152d32a5aa746482">checked</a>;
<a name="l00750"></a>00750         attribute.<a class="code" href="structAttribute.html#8a29ec3705c795db68ce2a64aebd2c48">status</a> = <a class="code" href="FatDefs_8h.html#e17eeb06f496b8ec152d32a5aa746482">checked</a>;
<a name="l00751"></a>00751         attribute.<a class="code" href="structAttribute.html#1e9b5af14a50071b88f2c45ca12e6fc0">file</a> = <a class="code" href="FatDefs_8h.html#ef5bc51f67c258e3de36353bc58c3dd7">unchecked</a>;
<a name="l00752"></a>00752 
<a name="l00753"></a>00753         <span class="keywordflow">if</span> (attr == <span class="charliteral">'1'</span>) {
<a name="l00754"></a>00754                 attribute.<a class="code" href="structAttribute.html#4d96cf5f87e43b02038d890c0d795666">readOnly</a> = <a class="code" href="FatDefs_8h.html#e17eeb06f496b8ec152d32a5aa746482">checked</a>;
<a name="l00755"></a>00755         }
<a name="l00756"></a>00756 
<a name="l00757"></a>00757         fileSize = 1;
<a name="l00758"></a>00758 
<a name="l00759"></a>00759         <a class="code" href="Fat_8c.html#6898244ccdbbe8f9ab35001524802626" title="Acrescenta uma entrada de um diretório para outro.">addDirectoryEntry</a>(driveNumber,
<a name="l00760"></a>00760                         VolumesListed[driveNumber].actualDirectory.startCluster, name,
<a name="l00761"></a>00761                         attribute, fileSize);
<a name="l00762"></a>00762         <span class="comment">//pega o primeiro cluster disponível na LBL para garvar o arquivo.</span>
<a name="l00763"></a>00763         startCluster = VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#12b2937b5c7692c9c00148163a5d699f">LBL</a>;
<a name="l00764"></a>00764         VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#12b2937b5c7692c9c00148163a5d699f">LBL</a>
<a name="l00765"></a>00765                         = VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#fd575cf6e0eb42eb1e1bd61617d9494d">fatList</a>[VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#12b2937b5c7692c9c00148163a5d699f">LBL</a>];
<a name="l00766"></a>00766 
<a name="l00767"></a>00767         <span class="keywordflow">for</span> (count = 0; count &lt; 16; count++) {
<a name="l00768"></a>00768                 <span class="keyword">new</span>[count].attribute.status = <a class="code" href="FatDefs_8h.html#ef5bc51f67c258e3de36353bc58c3dd7">unchecked</a>;
<a name="l00769"></a>00769         }
<a name="l00770"></a>00770 
<a name="l00771"></a>00771         <a class="code" href="Slib_8h.html#82c26cd350df88414f825bca40183ec2">memcpy</a>(buffer, <span class="keyword">new</span>, 512);
<a name="l00772"></a>00772         address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a> = startCluster;
<a name="l00773"></a>00773         <a class="code" href="Fat_8c.html#6c3231707b55e1e8cc48a1e7923839da" title="Pegar o valor da LBA*, e calcula o endereço do HD.">calcAddress</a>(driveNumber, &amp;address);
<a name="l00774"></a>00774         <a class="code" href="Ide_8c.html#a50554702a6b831c05346509d3a8bdc6" title="Grava informações no disco.">writeDisk</a>(driveNumber, &amp;address, buffer);
<a name="l00775"></a>00775         VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#fd575cf6e0eb42eb1e1bd61617d9494d">fatList</a>[address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a>] = <a class="code" href="FatDefs_8h.html#b6ad368e32c6304728c863dbb1e9d8dd">EOC</a>;
<a name="l00776"></a>00776 
<a name="l00777"></a>00777         <a class="code" href="Fat_8c.html#b2ef313f23df0aeadc3741f16bdcb75f" title="Grava as ultimas modificações da FAT no HD.">updateFat</a>(driveNumber);
<a name="l00778"></a>00778         <span class="keywordflow">return</span> <a class="code" href="Defs_8h.html#687984f47d8cce148d1b914d2b79612a" title="Successful exit status.">EXIT_SUCCESS</a>;
<a name="l00779"></a>00779 }
<a name="l00786"></a><a class="code" href="KFat_8h.html#ce93e750ab8efdb659bb2ee6afe3fd1f">00786</a> <span class="keywordtype">int</span> <a class="code" href="Fat_8c.html#ce93e750ab8efdb659bb2ee6afe3fd1f" title="Remove um DirectoryEntry do diretório atual.">delDirectoryEntry</a>(<span class="keywordtype">short</span> <span class="keywordtype">int</span> driveNumber, <span class="keywordtype">short</span> <span class="keywordtype">int</span> startCluster) {
<a name="l00787"></a>00787         <span class="keywordtype">short</span> <span class="keywordtype">int</span> count;
<a name="l00788"></a>00788         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <span class="keywordtype">int</span> position;
<a name="l00789"></a>00789         <span class="keyword">struct </span><a class="code" href="structfatDirectory.html" title="Estrutura que representa as entradas de um diretório.">fatDirectory</a> *directoryEntry;
<a name="l00790"></a>00790         <span class="keyword">struct </span><a class="code" href="structdiskAddress.html" title="Estrutura responsável por armazenar o endereço de uma posição do HD.">diskAddress</a> address;
<a name="l00791"></a>00791         <span class="keywordtype">char</span> buffer[512];
<a name="l00792"></a>00792         <span class="keywordtype">short</span> <span class="keywordtype">int</span> end = 0;
<a name="l00793"></a>00793 
<a name="l00794"></a>00794         address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a> = startCluster;
<a name="l00795"></a>00795         <a class="code" href="Fat_8c.html#6c3231707b55e1e8cc48a1e7923839da" title="Pegar o valor da LBA*, e calcula o endereço do HD.">calcAddress</a>(driveNumber, &amp;address);
<a name="l00796"></a>00796 
<a name="l00797"></a>00797         <a class="code" href="Ide_8c.html#49f300dd0c1649ae2c02f98f021592a6" title="Ler informações no disco.">readDisk</a>(driveNumber, &amp;address, buffer);
<a name="l00798"></a>00798         directoryEntry = (<span class="keyword">struct </span><a class="code" href="structfatDirectory.html" title="Estrutura que representa as entradas de um diretório.">fatDirectory</a> *) buffer;
<a name="l00799"></a>00799 
<a name="l00800"></a>00800         position = startCluster;
<a name="l00801"></a>00801         <span class="comment">/*</span>
<a name="l00802"></a>00802 <span class="comment">         *Neste loop deve-se passar por todos os registros que estão guardados,</span>
<a name="l00803"></a>00803 <span class="comment">         * caso algum dos registros seja um arquivo ele deve chamar a função de deletar arquivos e </span>
<a name="l00804"></a>00804 <span class="comment">         * deletá-lo, caso seja um diretório, ele deverá chamar essa função de forma</span>
<a name="l00805"></a>00805 <span class="comment">         * recursiva, até deletar todos arquivos e diretórios dentro dele.</span>
<a name="l00806"></a>00806 <span class="comment">         */</span>
<a name="l00807"></a>00807         count = 0;
<a name="l00808"></a>00808         end = 0;
<a name="l00809"></a>00809         <span class="keywordflow">while</span> (end!= 1) {
<a name="l00810"></a>00810                 <span class="keywordflow">while</span> (count &lt; 16) {
<a name="l00811"></a>00811                         <span class="keywordflow">if</span> (directoryEntry[count].<a class="code" href="structfatDirectory.html#16fb47757a9786affc18f93576abdb58">attribute</a>.<a class="code" href="structAttribute.html#8a29ec3705c795db68ce2a64aebd2c48">status</a> == <a class="code" href="FatDefs_8h.html#e17eeb06f496b8ec152d32a5aa746482">checked</a>
<a name="l00812"></a>00812                                         &amp;&amp; directoryEntry[count].<a class="code" href="structfatDirectory.html#16fb47757a9786affc18f93576abdb58">attribute</a>.<a class="code" href="structAttribute.html#1e9b5af14a50071b88f2c45ca12e6fc0">file</a> == <a class="code" href="FatDefs_8h.html#e17eeb06f496b8ec152d32a5aa746482">checked</a>) {
<a name="l00813"></a>00813                                 <span class="comment">//poderia ser passado o startCluster no lugar do position, entretando o position é mais eficiente,</span>
<a name="l00814"></a>00814                                 <span class="comment">//pois passa diretamente o lugar da fat que o arquivo a ser deletado esta.</span>
<a name="l00815"></a>00815                                 <a class="code" href="Fat_8c.html#fdc91eb61dc27e41e7a89455c9909316" title="Deleta um arquivo do diretório atual.">delFile</a>(driveNumber, directoryEntry[count].<a class="code" href="structfatDirectory.html#34150d64347f0bafe36f0781e17a2f16">file</a>.<a class="code" href="structName.html#8739c71aa4a6b401b61bd741ef390194">name</a>,
<a name="l00816"></a>00816                                                 directoryEntry[count].<a class="code" href="structfatDirectory.html#34150d64347f0bafe36f0781e17a2f16">file</a>.<a class="code" href="structName.html#4fbb7c79c3d895d551e797daed3fe30d">type</a>, position);
<a name="l00817"></a>00817                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (directoryEntry[count].<a class="code" href="structfatDirectory.html#16fb47757a9786affc18f93576abdb58">attribute</a>.<a class="code" href="structAttribute.html#8a29ec3705c795db68ce2a64aebd2c48">status</a> == <a class="code" href="FatDefs_8h.html#e17eeb06f496b8ec152d32a5aa746482">checked</a>
<a name="l00818"></a>00818                                         &amp;&amp; directoryEntry[count].<a class="code" href="structfatDirectory.html#16fb47757a9786affc18f93576abdb58">attribute</a>.<a class="code" href="structAttribute.html#352bfa638e4fe8f173f36479e6afb284">directory</a> == <a class="code" href="FatDefs_8h.html#e17eeb06f496b8ec152d32a5aa746482">checked</a>) {
<a name="l00819"></a>00819                                 <a class="code" href="Fat_8c.html#ce93e750ab8efdb659bb2ee6afe3fd1f" title="Remove um DirectoryEntry do diretório atual.">delDirectoryEntry</a>(driveNumber,
<a name="l00820"></a>00820                                                 directoryEntry[count].startCluster);
<a name="l00821"></a>00821                                 directoryEntry[count].<a class="code" href="structfatDirectory.html#16fb47757a9786affc18f93576abdb58">attribute</a>.<a class="code" href="structAttribute.html#8a29ec3705c795db68ce2a64aebd2c48">status</a> = <a class="code" href="FatDefs_8h.html#ef5bc51f67c258e3de36353bc58c3dd7">unchecked</a>;
<a name="l00822"></a>00822                         }
<a name="l00823"></a>00823 
<a name="l00824"></a>00824                         count++;
<a name="l00825"></a>00825                 }
<a name="l00826"></a>00826 
<a name="l00827"></a>00827                 <span class="keywordflow">if</span> (VolumesListed[driveNumber].fatList[position] == <a class="code" href="FatDefs_8h.html#b6ad368e32c6304728c863dbb1e9d8dd">EOC</a>) {
<a name="l00828"></a>00828                         end = 1;
<a name="l00829"></a>00829                 } <span class="keywordflow">else</span> {
<a name="l00830"></a>00830                         position = VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#fd575cf6e0eb42eb1e1bd61617d9494d">fatList</a>[position];
<a name="l00831"></a>00831                         count = 0;
<a name="l00832"></a>00832                         address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a> = position;
<a name="l00833"></a>00833                         <a class="code" href="Fat_8c.html#6c3231707b55e1e8cc48a1e7923839da" title="Pegar o valor da LBA*, e calcula o endereço do HD.">calcAddress</a>(driveNumber, &amp;address);
<a name="l00834"></a>00834                         <a class="code" href="Ide_8c.html#49f300dd0c1649ae2c02f98f021592a6" title="Ler informações no disco.">readDisk</a>(driveNumber, &amp;address, buffer);
<a name="l00835"></a>00835                         directoryEntry = (<span class="keyword">struct </span><a class="code" href="structfatDirectory.html" title="Estrutura que representa as entradas de um diretório.">fatDirectory</a> *) buffer;
<a name="l00836"></a>00836                 }
<a name="l00837"></a>00837         }
<a name="l00838"></a>00838 
<a name="l00839"></a>00839         VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#fd575cf6e0eb42eb1e1bd61617d9494d">fatList</a>[position]
<a name="l00840"></a>00840                         = VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#12b2937b5c7692c9c00148163a5d699f">LBL</a>;
<a name="l00841"></a>00841         VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#12b2937b5c7692c9c00148163a5d699f">LBL</a> = startCluster;
<a name="l00842"></a>00842 
<a name="l00843"></a>00843         <a class="code" href="Fat_8c.html#b2ef313f23df0aeadc3741f16bdcb75f" title="Grava as ultimas modificações da FAT no HD.">updateFat</a>(driveNumber);
<a name="l00844"></a>00844         <span class="keywordflow">return</span> <a class="code" href="Defs_8h.html#687984f47d8cce148d1b914d2b79612a" title="Successful exit status.">EXIT_SUCCESS</a>;
<a name="l00845"></a>00845 }
<a name="l00852"></a>00852 <span class="comment">//ATENÇÃO, ele usa recursão.</span>
<a name="l00853"></a><a class="code" href="KFat_8h.html#ac40f6c5bdbc9e36558946572c22f971">00853</a> <span class="keywordtype">int</span> <a class="code" href="Fat_8c.html#ac40f6c5bdbc9e36558946572c22f971" title="Deleta todos os arquivos e diretórios contidos no arquivo tb.">delDir</a>(<span class="keywordtype">short</span> <span class="keywordtype">int</span> driveNumber, <span class="keywordtype">char</span> *fileName) {
<a name="l00854"></a>00854         <span class="keywordtype">int</span> count;
<a name="l00855"></a>00855         <span class="keywordtype">short</span> <span class="keywordtype">int</span> position;
<a name="l00856"></a>00856         <span class="keyword">struct </span><a class="code" href="structdiskAddress.html" title="Estrutura responsável por armazenar o endereço de uma posição do HD.">diskAddress</a> address;
<a name="l00857"></a>00857         <span class="keyword">struct </span><a class="code" href="structfatDirectory.html" title="Estrutura que representa as entradas de um diretório.">fatDirectory</a> *entry;
<a name="l00858"></a>00858         <span class="keywordtype">char</span> buffer[512];
<a name="l00859"></a>00859 
<a name="l00860"></a>00860         address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a>= VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#eda5a7c1a9a78740fcd1029544c08a3d">actualDirectory</a>.<a class="code" href="structfatDirectory.html#c0cc3c681cc7daddcd54257becc6b2dd">startCluster</a>;
<a name="l00861"></a>00861         <a class="code" href="Fat_8c.html#6c3231707b55e1e8cc48a1e7923839da" title="Pegar o valor da LBA*, e calcula o endereço do HD.">calcAddress</a>(driveNumber, &amp;address);
<a name="l00862"></a>00862         <a class="code" href="Ide_8c.html#49f300dd0c1649ae2c02f98f021592a6" title="Ler informações no disco.">readDisk</a>(driveNumber, &amp;address, buffer);
<a name="l00863"></a>00863         entry = (<span class="keyword">struct </span><a class="code" href="structfatDirectory.html" title="Estrutura que representa as entradas de um diretório.">fatDirectory</a> *) buffer;
<a name="l00864"></a>00864         count = 0;
<a name="l00865"></a>00865         position = 16;
<a name="l00866"></a>00866         <span class="keywordflow">while</span> (position == 16) {
<a name="l00867"></a>00867                 <span class="keywordflow">while</span> (count &lt; 16) {
<a name="l00868"></a>00868                         <span class="keywordflow">if</span> (<a class="code" href="Slib_8h.html#15bde2174f2412867fc36278b65af29c">strcmp</a>(fileName, entry[count].<a class="code" href="structfatDirectory.html#34150d64347f0bafe36f0781e17a2f16">file</a>.<a class="code" href="structName.html#8739c71aa4a6b401b61bd741ef390194">name</a>)) {
<a name="l00869"></a>00869                                 position = count;
<a name="l00870"></a>00870                                 count = 16;
<a name="l00871"></a>00871                         }
<a name="l00872"></a>00872                         count++;
<a name="l00873"></a>00873                 }
<a name="l00874"></a>00874                 <span class="keywordflow">if</span> (position == 16 &amp;&amp; VolumesListed[driveNumber].fatList[address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a>]
<a name="l00875"></a>00875                                 != <a class="code" href="FatDefs_8h.html#b6ad368e32c6304728c863dbb1e9d8dd">EOC</a>) {
<a name="l00876"></a>00876                         address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a> = VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#fd575cf6e0eb42eb1e1bd61617d9494d">fatList</a>[address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a>];
<a name="l00877"></a>00877                         <a class="code" href="Fat_8c.html#6c3231707b55e1e8cc48a1e7923839da" title="Pegar o valor da LBA*, e calcula o endereço do HD.">calcAddress</a>(driveNumber, &amp;address);
<a name="l00878"></a>00878                         <a class="code" href="Ide_8c.html#49f300dd0c1649ae2c02f98f021592a6" title="Ler informações no disco.">readDisk</a>(driveNumber, &amp;address, buffer);
<a name="l00879"></a>00879                         entry = (<span class="keyword">struct </span><a class="code" href="structfatDirectory.html" title="Estrutura que representa as entradas de um diretório.">fatDirectory</a> *) buffer;
<a name="l00880"></a>00880                         count = 0;
<a name="l00881"></a>00881                 } 
<a name="l00882"></a>00882         }
<a name="l00883"></a>00883         <span class="keywordflow">if</span>(position &lt; 16){
<a name="l00884"></a>00884                 <a class="code" href="Fat_8c.html#ce93e750ab8efdb659bb2ee6afe3fd1f" title="Remove um DirectoryEntry do diretório atual.">delDirectoryEntry</a>(driveNumber, entry[position].<a class="code" href="structfatDirectory.html#c0cc3c681cc7daddcd54257becc6b2dd">startCluster</a>);
<a name="l00885"></a>00885         
<a name="l00886"></a>00886                 entry[position].<a class="code" href="structfatDirectory.html#16fb47757a9786affc18f93576abdb58">attribute</a>.<a class="code" href="structAttribute.html#8a29ec3705c795db68ce2a64aebd2c48">status</a> = <a class="code" href="FatDefs_8h.html#ef5bc51f67c258e3de36353bc58c3dd7">unchecked</a>;
<a name="l00887"></a>00887         
<a name="l00888"></a>00888                 <a class="code" href="Slib_8h.html#82c26cd350df88414f825bca40183ec2">memcpy</a>(buffer, entry, 512);
<a name="l00889"></a>00889                 <a class="code" href="Ide_8c.html#a50554702a6b831c05346509d3a8bdc6" title="Grava informações no disco.">writeDisk</a>(driveNumber, &amp;address, buffer);
<a name="l00890"></a>00890         
<a name="l00891"></a>00891                 <a class="code" href="Fat_8c.html#b2ef313f23df0aeadc3741f16bdcb75f" title="Grava as ultimas modificações da FAT no HD.">updateFat</a>(driveNumber);
<a name="l00892"></a>00892                 <span class="keywordflow">return</span> <a class="code" href="Defs_8h.html#687984f47d8cce148d1b914d2b79612a" title="Successful exit status.">EXIT_SUCCESS</a>;
<a name="l00893"></a>00893         }<span class="keywordflow">else</span>{
<a name="l00894"></a>00894                 <a class="code" href="Scrn_8h.html#ffb7f407d6601f057a9c641482a344a0" title="Usa uma rotina para imprimi uma STRING.">puts</a>(<span class="stringliteral">"esse diretorio nao existe."</span>);
<a name="l00895"></a>00895                 <span class="keywordflow">return</span> <a class="code" href="Defs_8h.html#73efe787c131b385070f25d18b7c9aa4" title="Failing exit status.">EXIT_FAILURE</a>;
<a name="l00896"></a>00896         }
<a name="l00897"></a>00897         
<a name="l00898"></a>00898 }
<a name="l00905"></a><a class="code" href="KFat_8h.html#a06f318d5d5e6dc5eb78278a4ad3e809">00905</a> <span class="keywordtype">int</span> <a class="code" href="Fat_8c.html#a06f318d5d5e6dc5eb78278a4ad3e809" title="atualiza o diretório atual para algum que seja filho do atual.">refreshDirectoryEnter</a>(<span class="keywordtype">short</span> <span class="keywordtype">int</span> driveNumber, <span class="keywordtype">char</span> *name) {
<a name="l00906"></a>00906         <span class="keywordtype">short</span> <span class="keywordtype">int</span> count;
<a name="l00907"></a>00907         <span class="keyword">struct </span><a class="code" href="structfatDirectory.html" title="Estrutura que representa as entradas de um diretório.">fatDirectory</a> *directoryEntry;
<a name="l00908"></a>00908         <span class="keyword">struct </span><a class="code" href="structdiskAddress.html" title="Estrutura responsável por armazenar o endereço de uma posição do HD.">diskAddress</a> address;
<a name="l00909"></a>00909         <span class="keywordtype">char</span> buffer[512];
<a name="l00910"></a>00910         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <span class="keywordtype">int</span> position;
<a name="l00911"></a>00911         <span class="keywordtype">int</span> letter;
<a name="l00912"></a>00912         <span class="keywordtype">char</span> nameBuffer[9];
<a name="l00913"></a>00913 
<a name="l00914"></a>00914         address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a> = VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#eda5a7c1a9a78740fcd1029544c08a3d">actualDirectory</a>.<a class="code" href="structfatDirectory.html#c0cc3c681cc7daddcd54257becc6b2dd">startCluster</a>;
<a name="l00915"></a>00915         <a class="code" href="Fat_8c.html#6c3231707b55e1e8cc48a1e7923839da" title="Pegar o valor da LBA*, e calcula o endereço do HD.">calcAddress</a>(driveNumber, &amp;address);
<a name="l00916"></a>00916         <a class="code" href="Ide_8c.html#49f300dd0c1649ae2c02f98f021592a6" title="Ler informações no disco.">readDisk</a>(driveNumber, &amp;address, buffer);
<a name="l00917"></a>00917         directoryEntry = (<span class="keyword">struct </span><a class="code" href="structfatDirectory.html" title="Estrutura que representa as entradas de um diretório.">fatDirectory</a> *) buffer;
<a name="l00918"></a>00918 
<a name="l00919"></a>00919         count = 0;
<a name="l00920"></a>00920         position = 16;
<a name="l00921"></a>00921         <span class="keywordflow">while</span> (count &lt; 17) {
<a name="l00922"></a>00922                 <span class="keywordflow">while</span> (count &lt; 16) {
<a name="l00923"></a>00923                         letter = 0;
<a name="l00924"></a>00924 
<a name="l00925"></a>00925                         <span class="keywordflow">while</span> (letter &lt; 8&amp;&amp; directoryEntry[count].<a class="code" href="structfatDirectory.html#34150d64347f0bafe36f0781e17a2f16">file</a>.<a class="code" href="structName.html#8739c71aa4a6b401b61bd741ef390194">name</a>[letter] != <span class="charliteral">'\0'</span>) {
<a name="l00926"></a>00926                                 nameBuffer[letter] = directoryEntry[count].<a class="code" href="structfatDirectory.html#34150d64347f0bafe36f0781e17a2f16">file</a>.<a class="code" href="structName.html#8739c71aa4a6b401b61bd741ef390194">name</a>[letter];
<a name="l00927"></a>00927                                 letter++;
<a name="l00928"></a>00928                         }
<a name="l00929"></a>00929                         nameBuffer[letter] = <span class="charliteral">'\0'</span>;
<a name="l00930"></a>00930 
<a name="l00931"></a>00931                         <span class="keywordflow">if</span> (<a class="code" href="Slib_8h.html#15bde2174f2412867fc36278b65af29c">strcmp</a>(nameBuffer, name)
<a name="l00932"></a>00932                                         &amp;&amp; directoryEntry[count].<a class="code" href="structfatDirectory.html#16fb47757a9786affc18f93576abdb58">attribute</a>.<a class="code" href="structAttribute.html#352bfa638e4fe8f173f36479e6afb284">directory</a> == <a class="code" href="FatDefs_8h.html#e17eeb06f496b8ec152d32a5aa746482">checked</a>) {
<a name="l00933"></a>00933                                 position = count;
<a name="l00934"></a>00934                                 count = 17;
<a name="l00935"></a>00935                         }
<a name="l00936"></a>00936                         count++;
<a name="l00937"></a>00937                 }
<a name="l00938"></a>00938                 <span class="keywordflow">if</span> (VolumesListed[driveNumber].fatList[address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a>] != <a class="code" href="FatDefs_8h.html#b6ad368e32c6304728c863dbb1e9d8dd">EOC</a>&amp;&amp; position
<a name="l00939"></a>00939                                 == 16) {
<a name="l00940"></a>00940                         address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a> = VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#fd575cf6e0eb42eb1e1bd61617d9494d">fatList</a>[address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a>];
<a name="l00941"></a>00941                         <a class="code" href="Fat_8c.html#6c3231707b55e1e8cc48a1e7923839da" title="Pegar o valor da LBA*, e calcula o endereço do HD.">calcAddress</a>(driveNumber, &amp;address);
<a name="l00942"></a>00942                         <a class="code" href="Ide_8c.html#49f300dd0c1649ae2c02f98f021592a6" title="Ler informações no disco.">readDisk</a>(driveNumber, &amp;address, buffer);
<a name="l00943"></a>00943                         directoryEntry = (<span class="keyword">struct </span><a class="code" href="structfatDirectory.html" title="Estrutura que representa as entradas de um diretório.">fatDirectory</a> *) buffer;
<a name="l00944"></a>00944                         count = 0;
<a name="l00945"></a>00945                 }<span class="comment">/* else if (count == 17) {</span>
<a name="l00946"></a>00946 <span class="comment">                        count = 17;</span>
<a name="l00947"></a>00947 <span class="comment">                }*/</span>
<a name="l00948"></a>00948         }
<a name="l00949"></a>00949 
<a name="l00950"></a>00950         <span class="keywordflow">if</span> (position &lt; 16) {
<a name="l00951"></a>00951                 VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#eda5a7c1a9a78740fcd1029544c08a3d">actualDirectory</a> = directoryEntry[position];
<a name="l00952"></a>00952                 <a class="code" href="Scrn_8h.html#ffb7f407d6601f057a9c641482a344a0" title="Usa uma rotina para imprimi uma STRING.">puts</a>(<span class="stringliteral">"Diretorio atualizado...."</span>);
<a name="l00953"></a>00953         }<span class="keywordflow">else</span>{
<a name="l00954"></a>00954                 <a class="code" href="Scrn_8h.html#ffb7f407d6601f057a9c641482a344a0" title="Usa uma rotina para imprimi uma STRING.">puts</a>(<span class="stringliteral">"Diretorio nao existente...."</span>);
<a name="l00955"></a>00955         }
<a name="l00956"></a>00956 
<a name="l00957"></a>00957         <span class="keywordflow">return</span> <a class="code" href="Defs_8h.html#687984f47d8cce148d1b914d2b79612a" title="Successful exit status.">EXIT_SUCCESS</a>;
<a name="l00958"></a>00958 }
<a name="l00964"></a><a class="code" href="KFat_8h.html#192789b92c69b7c8224a17915f33a7fc">00964</a> <span class="keywordtype">int</span> <a class="code" href="Fat_8c.html#192789b92c69b7c8224a17915f33a7fc" title="Esta função serve para imprimir na tela todas as informações do diretorio atual...">printDir</a>(<span class="keywordtype">short</span> <span class="keywordtype">int</span> driveNumber) {
<a name="l00965"></a>00965         <span class="keywordtype">short</span> <span class="keywordtype">int</span> count;
<a name="l00966"></a>00966         <span class="keyword">struct </span><a class="code" href="structfatDirectory.html" title="Estrutura que representa as entradas de um diretório.">fatDirectory</a> *directoryEntry;
<a name="l00967"></a>00967         <span class="keywordtype">char</span> buffer[512];
<a name="l00968"></a>00968         <span class="keywordtype">short</span> <span class="keywordtype">int</span> position;
<a name="l00969"></a>00969         <span class="keyword">struct </span><a class="code" href="structdiskAddress.html" title="Estrutura responsável por armazenar o endereço de uma posição do HD.">diskAddress</a> address;
<a name="l00970"></a>00970 
<a name="l00971"></a>00971         address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a> = VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#eda5a7c1a9a78740fcd1029544c08a3d">actualDirectory</a>.<a class="code" href="structfatDirectory.html#c0cc3c681cc7daddcd54257becc6b2dd">startCluster</a>;
<a name="l00972"></a>00972         <a class="code" href="Fat_8c.html#6c3231707b55e1e8cc48a1e7923839da" title="Pegar o valor da LBA*, e calcula o endereço do HD.">calcAddress</a>(driveNumber, &amp;address);
<a name="l00973"></a>00973         <a class="code" href="Ide_8c.html#49f300dd0c1649ae2c02f98f021592a6" title="Ler informações no disco.">readDisk</a>(driveNumber, &amp;address, buffer);
<a name="l00974"></a>00974         directoryEntry = (<span class="keyword">struct </span><a class="code" href="structfatDirectory.html" title="Estrutura que representa as entradas de um diretório.">fatDirectory</a> *) buffer;
<a name="l00975"></a>00975         count = 0;
<a name="l00976"></a>00976         position = 0;
<a name="l00977"></a>00977 
<a name="l00978"></a>00978         <span class="keywordflow">while</span> (position == 0) {
<a name="l00979"></a>00979                 <a class="code" href="Scrn_8h.html#273a809d3de4626e50ad4ecd05c44754" title="Responsável por imprimir mensagens de debug na tela.">APOSDEBUG</a>(<a class="code" href="Fat_8c.html#fb6a77f8fd1dc0be5fb353a7c656387f" title="Variavel que ativa o modo debug, se seu valor for TRUE(1) e desativa se for FALSE(0)...">debugVariable</a>, <span class="stringliteral">" \n comecando a listar os arquivos \n"</span>);
<a name="l00980"></a>00980                 <span class="keywordflow">while</span> (count &lt; 16) {
<a name="l00981"></a>00981                         <span class="keywordflow">if</span> (directoryEntry[count].<a class="code" href="structfatDirectory.html#16fb47757a9786affc18f93576abdb58">attribute</a>.<a class="code" href="structAttribute.html#8a29ec3705c795db68ce2a64aebd2c48">status</a> == <a class="code" href="FatDefs_8h.html#e17eeb06f496b8ec152d32a5aa746482">checked</a>) {
<a name="l00982"></a>00982                                 <a class="code" href="Scrn_8h.html#ffb7f407d6601f057a9c641482a344a0" title="Usa uma rotina para imprimi uma STRING.">puts</a>(<span class="stringliteral">" \n"</span>);
<a name="l00983"></a>00983                                 <a class="code" href="Scrn_8h.html#ffb7f407d6601f057a9c641482a344a0" title="Usa uma rotina para imprimi uma STRING.">puts</a>(directoryEntry[count].<a class="code" href="structfatDirectory.html#34150d64347f0bafe36f0781e17a2f16">file</a>.<a class="code" href="structName.html#8739c71aa4a6b401b61bd741ef390194">name</a>);
<a name="l00984"></a>00984                                 <span class="keywordflow">if</span> (directoryEntry[count].<a class="code" href="structfatDirectory.html#16fb47757a9786affc18f93576abdb58">attribute</a>.<a class="code" href="structAttribute.html#1e9b5af14a50071b88f2c45ca12e6fc0">file</a> == <a class="code" href="FatDefs_8h.html#e17eeb06f496b8ec152d32a5aa746482">checked</a>) {
<a name="l00985"></a>00985                                         <a class="code" href="Scrn_8h.html#ffb7f407d6601f057a9c641482a344a0" title="Usa uma rotina para imprimi uma STRING.">puts</a>(<span class="stringliteral">"."</span>);
<a name="l00986"></a>00986                                         <span class="keywordtype">char</span> typeBuffer[4];
<a name="l00987"></a>00987                                         typeBuffer[0] = directoryEntry[count].<a class="code" href="structfatDirectory.html#34150d64347f0bafe36f0781e17a2f16">file</a>.<a class="code" href="structName.html#4fbb7c79c3d895d551e797daed3fe30d">type</a>[0];
<a name="l00988"></a>00988                                         typeBuffer[1] = directoryEntry[count].<a class="code" href="structfatDirectory.html#34150d64347f0bafe36f0781e17a2f16">file</a>.<a class="code" href="structName.html#4fbb7c79c3d895d551e797daed3fe30d">type</a>[1];
<a name="l00989"></a>00989                                         typeBuffer[2] = directoryEntry[count].<a class="code" href="structfatDirectory.html#34150d64347f0bafe36f0781e17a2f16">file</a>.<a class="code" href="structName.html#4fbb7c79c3d895d551e797daed3fe30d">type</a>[2];
<a name="l00990"></a>00990                                         typeBuffer[3] = <span class="charliteral">'\0'</span>;
<a name="l00991"></a>00991                                         <a class="code" href="Scrn_8h.html#ffb7f407d6601f057a9c641482a344a0" title="Usa uma rotina para imprimi uma STRING.">puts</a>(typeBuffer);
<a name="l00992"></a>00992                                 } <span class="keywordflow">else</span> {
<a name="l00993"></a>00993                                         <a class="code" href="Scrn_8h.html#ffb7f407d6601f057a9c641482a344a0" title="Usa uma rotina para imprimi uma STRING.">puts</a>(<span class="stringliteral">"\\"</span>);
<a name="l00994"></a>00994                                 }
<a name="l00995"></a>00995                                 <a class="code" href="Scrn_8h.html#ffb7f407d6601f057a9c641482a344a0" title="Usa uma rotina para imprimi uma STRING.">puts</a>(<span class="stringliteral">"                             "</span>);
<a name="l00996"></a>00996                                 <a class="code" href="Scrn_8h.html#3b47c20d8bb9e5c9d3cd0137c247ed81" title="Imprime na tela um inteiro.">printfInt</a>(directoryEntry[count].<a class="code" href="structfatDirectory.html#c0cc3c681cc7daddcd54257becc6b2dd">startCluster</a>);
<a name="l00997"></a>00997                                 <a class="code" href="Scrn_8h.html#ffb7f407d6601f057a9c641482a344a0" title="Usa uma rotina para imprimi uma STRING.">puts</a>(<span class="stringliteral">"--"</span>);
<a name="l00998"></a>00998                                 <a class="code" href="Scrn_8h.html#3b47c20d8bb9e5c9d3cd0137c247ed81" title="Imprime na tela um inteiro.">printfInt</a>((<span class="keywordtype">int</span>)directoryEntry[count].<a class="code" href="structfatDirectory.html#4bea39f8d6c526ccab754274c10ea0d5">fileSize</a>);
<a name="l00999"></a>00999                         }
<a name="l01000"></a>01000                         count++;
<a name="l01001"></a>01001 
<a name="l01002"></a>01002                 }
<a name="l01003"></a>01003                 <a class="code" href="Scrn_8h.html#273a809d3de4626e50ad4ecd05c44754" title="Responsável por imprimir mensagens de debug na tela.">APOSDEBUG</a>(<a class="code" href="Fat_8c.html#fb6a77f8fd1dc0be5fb353a7c656387f" title="Variavel que ativa o modo debug, se seu valor for TRUE(1) e desativa se for FALSE(0)...">debugVariable</a>, <span class="stringliteral">" \n finalizando leitura de um registro \n"</span>);
<a name="l01004"></a>01004                 <span class="comment">//caso o o diretorio tenha mais de 16 items, ele pega o proximo cluster</span>
<a name="l01005"></a>01005                 <span class="keywordflow">if</span> (VolumesListed[driveNumber].fatList[address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a>] != <a class="code" href="FatDefs_8h.html#b6ad368e32c6304728c863dbb1e9d8dd">EOC</a>) {
<a name="l01006"></a>01006                         <a class="code" href="Scrn_8h.html#273a809d3de4626e50ad4ecd05c44754" title="Responsável por imprimir mensagens de debug na tela.">APOSDEBUG</a>(<a class="code" href="Fat_8c.html#fb6a77f8fd1dc0be5fb353a7c656387f" title="Variavel que ativa o modo debug, se seu valor for TRUE(1) e desativa se for FALSE(0)...">debugVariable</a>, <span class="stringliteral">" \n comecando a ler outro registro \n"</span>);
<a name="l01007"></a>01007                         address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a> = VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#fd575cf6e0eb42eb1e1bd61617d9494d">fatList</a>[address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a>];
<a name="l01008"></a>01008                         <a class="code" href="Fat_8c.html#6c3231707b55e1e8cc48a1e7923839da" title="Pegar o valor da LBA*, e calcula o endereço do HD.">calcAddress</a>(driveNumber, &amp;address);
<a name="l01009"></a>01009                         <a class="code" href="Ide_8c.html#49f300dd0c1649ae2c02f98f021592a6" title="Ler informações no disco.">readDisk</a>(driveNumber, &amp;address, buffer);
<a name="l01010"></a>01010                         directoryEntry = (<span class="keyword">struct </span><a class="code" href="structfatDirectory.html" title="Estrutura que representa as entradas de um diretório.">fatDirectory</a> *) buffer;
<a name="l01011"></a>01011                         count = 0;
<a name="l01012"></a>01012                 } <span class="keywordflow">else</span> {
<a name="l01013"></a>01013                         <a class="code" href="Scrn_8h.html#ffb7f407d6601f057a9c641482a344a0" title="Usa uma rotina para imprimi uma STRING.">puts</a>(<span class="stringliteral">"\n fim lista.... \n"</span>);
<a name="l01014"></a>01014                         position = 20;
<a name="l01015"></a>01015                 }
<a name="l01016"></a>01016         }
<a name="l01017"></a>01017         <span class="keywordflow">return</span> <a class="code" href="Defs_8h.html#687984f47d8cce148d1b914d2b79612a" title="Successful exit status.">EXIT_SUCCESS</a>;
<a name="l01018"></a>01018 }
<a name="l01026"></a><a class="code" href="Fat_8c.html#955bff276626d02d07e1d267a4544331">01026</a> <span class="keywordtype">int</span> <a class="code" href="Fat_8c.html#955bff276626d02d07e1d267a4544331" title="Modifica qualquer informação de um determinada item de um diretório.">modifyEntry</a>(<span class="keywordtype">short</span> <span class="keywordtype">int</span> driveNumber, <span class="keyword">struct</span> <a class="code" href="structName.html" title="Representa o nome de um arquivo ou diretório.">Name</a> fileName,
<a name="l01027"></a>01027                 <span class="keyword">struct</span> <a class="code" href="structfatDirectory.html" title="Estrutura que representa as entradas de um diretório.">fatDirectory</a> *directoryEntry) {
<a name="l01028"></a>01028         <span class="keywordtype">int</span> position;
<a name="l01029"></a>01029         <span class="keywordtype">int</span> count;
<a name="l01030"></a>01030         <span class="keyword">struct </span><a class="code" href="structfatDirectory.html" title="Estrutura que representa as entradas de um diretório.">fatDirectory</a> *entry;
<a name="l01031"></a>01031         <span class="keywordtype">char</span> buffer[512];
<a name="l01032"></a>01032         <span class="keyword">struct </span><a class="code" href="structdiskAddress.html" title="Estrutura responsável por armazenar o endereço de uma posição do HD.">diskAddress</a> address;
<a name="l01033"></a>01033 
<a name="l01034"></a>01034         address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a> = VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#eda5a7c1a9a78740fcd1029544c08a3d">actualDirectory</a>.<a class="code" href="structfatDirectory.html#c0cc3c681cc7daddcd54257becc6b2dd">startCluster</a>;
<a name="l01035"></a>01035         <a class="code" href="Fat_8c.html#6c3231707b55e1e8cc48a1e7923839da" title="Pegar o valor da LBA*, e calcula o endereço do HD.">calcAddress</a>(driveNumber, &amp;address);
<a name="l01036"></a>01036         <a class="code" href="Ide_8c.html#49f300dd0c1649ae2c02f98f021592a6" title="Ler informações no disco.">readDisk</a>(driveNumber, &amp;address, buffer);
<a name="l01037"></a>01037         directoryEntry = (<span class="keyword">struct </span><a class="code" href="structfatDirectory.html" title="Estrutura que representa as entradas de um diretório.">fatDirectory</a> *) buffer;
<a name="l01038"></a>01038 
<a name="l01039"></a>01039         count = 0;
<a name="l01040"></a>01040         position = 16;
<a name="l01041"></a>01041 
<a name="l01042"></a>01042         <span class="keywordflow">if</span> (directoryEntry-&gt;<a class="code" href="structfatDirectory.html#16fb47757a9786affc18f93576abdb58">attribute</a>.<a class="code" href="structAttribute.html#8a29ec3705c795db68ce2a64aebd2c48">status</a> == <a class="code" href="FatDefs_8h.html#e17eeb06f496b8ec152d32a5aa746482">checked</a>&amp;&amp; <a class="code" href="Slib_8h.html#c6b5c6676a3d76674a299a4c92e54e27">strlenght</a>(fileName.<a class="code" href="structName.html#4fbb7c79c3d895d551e797daed3fe30d">type</a>)
<a name="l01043"></a>01043                         == 0) {
<a name="l01044"></a>01044                 <span class="keywordflow">while</span> (position == 16) {
<a name="l01045"></a>01045                         <span class="keywordflow">while</span> (count &lt; 16) {
<a name="l01046"></a>01046                                 <span class="keywordflow">if</span> (<a class="code" href="Slib_8h.html#15bde2174f2412867fc36278b65af29c">strcmp</a>(fileName.<a class="code" href="structName.html#8739c71aa4a6b401b61bd741ef390194">name</a>, entry[count].<a class="code" href="structfatDirectory.html#34150d64347f0bafe36f0781e17a2f16">file</a>.<a class="code" href="structName.html#8739c71aa4a6b401b61bd741ef390194">name</a>)) {
<a name="l01047"></a>01047                                         position = count;
<a name="l01048"></a>01048                                         count = 16;
<a name="l01049"></a>01049                                 }
<a name="l01050"></a>01050                                 count++;
<a name="l01051"></a>01051                         }
<a name="l01052"></a>01052                         <span class="keywordflow">if</span> (position == 16
<a name="l01053"></a>01053                                         &amp;&amp; VolumesListed[driveNumber].fatList[address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a>]!= <a class="code" href="FatDefs_8h.html#b6ad368e32c6304728c863dbb1e9d8dd">EOC</a>) {
<a name="l01054"></a>01054                                 address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a> = VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#fd575cf6e0eb42eb1e1bd61617d9494d">fatList</a>[address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a>];
<a name="l01055"></a>01055                                 <a class="code" href="Fat_8c.html#6c3231707b55e1e8cc48a1e7923839da" title="Pegar o valor da LBA*, e calcula o endereço do HD.">calcAddress</a>(driveNumber, &amp;address);
<a name="l01056"></a>01056                                 <a class="code" href="Ide_8c.html#49f300dd0c1649ae2c02f98f021592a6" title="Ler informações no disco.">readDisk</a>(driveNumber, &amp;address, buffer);
<a name="l01057"></a>01057                                 entry = (<span class="keyword">struct </span><a class="code" href="structfatDirectory.html" title="Estrutura que representa as entradas de um diretório.">fatDirectory</a> *) buffer;
<a name="l01058"></a>01058                                 count = 0;
<a name="l01059"></a>01059                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (position == 16) {
<a name="l01060"></a>01060                                 position = 17;
<a name="l01061"></a>01061                         }
<a name="l01062"></a>01062                 }
<a name="l01063"></a>01063         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (directoryEntry-&gt;<a class="code" href="structfatDirectory.html#16fb47757a9786affc18f93576abdb58">attribute</a>.<a class="code" href="structAttribute.html#8a29ec3705c795db68ce2a64aebd2c48">status</a> == <a class="code" href="FatDefs_8h.html#e17eeb06f496b8ec152d32a5aa746482">checked</a>
<a name="l01064"></a>01064                         &amp;&amp; <a class="code" href="Slib_8h.html#c6b5c6676a3d76674a299a4c92e54e27">strlenght</a>(fileName.<a class="code" href="structName.html#4fbb7c79c3d895d551e797daed3fe30d">type</a>) != 0) {
<a name="l01065"></a>01065                 <span class="keywordflow">while</span> (position == 16) {
<a name="l01066"></a>01066                         <span class="keywordflow">while</span> (count &lt; 16) {
<a name="l01067"></a>01067                                 <span class="keywordflow">if</span> ((<a class="code" href="Slib_8h.html#15bde2174f2412867fc36278b65af29c">strcmp</a>(fileName.<a class="code" href="structName.html#8739c71aa4a6b401b61bd741ef390194">name</a>, entry[count].<a class="code" href="structfatDirectory.html#34150d64347f0bafe36f0781e17a2f16">file</a>.<a class="code" href="structName.html#8739c71aa4a6b401b61bd741ef390194">name</a>))&amp;&amp; (<a class="code" href="Slib_8h.html#15bde2174f2412867fc36278b65af29c">strcmp</a>(
<a name="l01068"></a>01068                                                 fileName.<a class="code" href="structName.html#4fbb7c79c3d895d551e797daed3fe30d">type</a>, entry[count].<a class="code" href="structfatDirectory.html#34150d64347f0bafe36f0781e17a2f16">file</a>.<a class="code" href="structName.html#4fbb7c79c3d895d551e797daed3fe30d">type</a>))) {
<a name="l01069"></a>01069                                         position = count;
<a name="l01070"></a>01070                                         count = 16;
<a name="l01071"></a>01071                                 }
<a name="l01072"></a>01072                                 count++;
<a name="l01073"></a>01073                         }
<a name="l01074"></a>01074                         <span class="keywordflow">if</span> (position == 16
<a name="l01075"></a>01075                                         &amp;&amp; VolumesListed[driveNumber].fatList[address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a>]!= <a class="code" href="FatDefs_8h.html#b6ad368e32c6304728c863dbb1e9d8dd">EOC</a>) {
<a name="l01076"></a>01076                                 address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a> = VolumesListed[driveNumber].<a class="code" href="structFatInstance.html#fd575cf6e0eb42eb1e1bd61617d9494d">fatList</a>[address.<a class="code" href="structdiskAddress.html#ad283e69dfbef6b1323cdc18ba3dc46c">lba</a>];
<a name="l01077"></a>01077                                 <a class="code" href="Fat_8c.html#6c3231707b55e1e8cc48a1e7923839da" title="Pegar o valor da LBA*, e calcula o endereço do HD.">calcAddress</a>(driveNumber, &amp;address);
<a name="l01078"></a>01078                                 <a class="code" href="Ide_8c.html#49f300dd0c1649ae2c02f98f021592a6" title="Ler informações no disco.">readDisk</a>(driveNumber, &amp;address, buffer);
<a name="l01079"></a>01079                                 entry = (<span class="keyword">struct </span><a class="code" href="structfatDirectory.html" title="Estrutura que representa as entradas de um diretório.">fatDirectory</a> *) buffer;
<a name="l01080"></a>01080                                 count = 0;
<a name="l01081"></a>01081                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (position == 16) {
<a name="l01082"></a>01082                                 position = 17;
<a name="l01083"></a>01083                         }
<a name="l01084"></a>01084                 }
<a name="l01085"></a>01085         }
<a name="l01086"></a>01086         <span class="keywordflow">if</span> (position != 17) {
<a name="l01087"></a>01087                 entry[position] = *directoryEntry;
<a name="l01088"></a>01088                 <a class="code" href="Slib_8h.html#82c26cd350df88414f825bca40183ec2">memcpy</a>(buffer, entry, 512);
<a name="l01089"></a>01089 
<a name="l01090"></a>01090                 <a class="code" href="Ide_8c.html#a50554702a6b831c05346509d3a8bdc6" title="Grava informações no disco.">writeDisk</a>(driveNumber, &amp;address, buffer);
<a name="l01091"></a>01091         } <span class="keywordflow">else</span> {
<a name="l01092"></a>01092                 <a class="code" href="Scrn_8h.html#ffb7f407d6601f057a9c641482a344a0" title="Usa uma rotina para imprimi uma STRING.">puts</a>(<span class="stringliteral">"arquivo nao encontrado"</span>);
<a name="l01093"></a>01093         }
<a name="l01094"></a>01094 
<a name="l01095"></a>01095         <span class="keywordflow">return</span> <a class="code" href="Defs_8h.html#687984f47d8cce148d1b914d2b79612a" title="Successful exit status.">EXIT_SUCCESS</a>;
<a name="l01096"></a>01096 }
<a name="l01097"></a>01097 
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Gerado em Sat Mar 22 18:49:29 2008 para APOS por&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.5 </small></address>
</body>
</html>
